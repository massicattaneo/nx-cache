{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/apps/client-web/src/app/pages/Workflows/Workflow.tsx"],"sourcesContent":["import { useCallback, useEffect, useState } from \"react\"\nimport isEmpty from \"lodash/isEmpty\"\nimport { useNavigate, useParams } from \"react-router-dom\"\nimport { ChatWatchlistEntity } from \"@rp/common/api-types\"\nimport { HEADER_HEIGHT } from \"@rp/common/settings\"\nimport {\n  type TimeframeOption,\n  type WorkflowData,\n  type WorkflowState,\n  WorkflowSteps,\n  getWorkflowDefaultDateFilter,\n} from \"@rp/react/common/workflow\"\nimport { Sector, Steps, useWorkflow } from \"@rp/react/tanstack-api/workflow\"\nimport { BriefPageHeader } from \"@rp/react/web/brief\"\nimport { PageWrapperStyled } from \"@rp/react/web/common/base-components\"\nimport {\n  VERTICAL_SCROLL_STEP_CLASS_NAME,\n  VerticalScrollStepper,\n} from \"@rp/react/web/common/composite-components\"\nimport { HtmlPageHead } from \"@rp/react/web/common/header-components\"\nimport { useSnackbar } from \"@rp/react/web/common/providers\"\nimport { DocumentViewerPage } from \"@rp/react/web/document-viewer\"\nimport { Box, CircularProgress } from \"@rp/react/web/mui/core\"\nimport { CHAT_ROUTE } from \"@rp/react/web/router\"\nimport {\n  CompanySearchAutocomplete,\n  CustomInstructions,\n  SectorSelector,\n  TimeframeSelector,\n} from \"@rp/react/web/workflow\"\nimport { useFeatureAtom } from \"../../atoms/feature-flags\"\n\nconst Workflow = () => {\n  const { id } = useParams()\n  const navigate = useNavigate()\n  const { enqueueError } = useSnackbar()\n  const [enableCustomInstructions] = useFeatureAtom(\"enableCustomInstructions\")\n  const { isLoading, data: workflow, error } = useWorkflow(id ?? \"\", { enableCustomInstructions })\n\n  const [activeStep, setActiveStep] = useState(WorkflowSteps.SELECT_COMPANIES)\n  const [workflowData, setWorkflowData] = useState<WorkflowData>({\n    selectedCompanies: [],\n  })\n\n  const handleComplete = useCallback(() => {\n    if (workflow) {\n      const defaultDateFilter = getWorkflowDefaultDateFilter(workflow)\n      const workflowState: WorkflowState = {\n        originWorkflow: workflow,\n        selectedData:\n          workflow.behavior === \"direct\"\n            ? { ...workflowData, selectedTimeframe: defaultDateFilter }\n            : workflowData,\n      }\n      navigate(CHAT_ROUTE, { state: { workflow: workflowState }, replace: true })\n    }\n  }, [workflow, workflowData, navigate])\n\n  const updateWorkflowData = useCallback((updates: Partial<WorkflowData>) => {\n    setWorkflowData(prev => ({ ...prev, ...updates }))\n  }, [])\n\n  const handleCompanySelection = useCallback(\n    (companies: Array<ChatWatchlistEntity>) => {\n      updateWorkflowData({ selectedCompanies: companies })\n    },\n    [updateWorkflowData],\n  )\n\n  const handleTimeframeSelection = useCallback(\n    (timeframe: TimeframeOption) => {\n      updateWorkflowData({ selectedTimeframe: timeframe })\n    },\n    [updateWorkflowData],\n  )\n\n  const handleSectorSelection = useCallback(\n    (sector: Sector) => {\n      updateWorkflowData({ selectedSector: sector })\n    },\n    [updateWorkflowData],\n  )\n\n  const handleCustomInstructionsChange = useCallback(\n    (text: string) => {\n      updateWorkflowData({ customInstructions: text })\n    },\n    [updateWorkflowData],\n  )\n\n  const getNextButtonDisabled = useCallback(\n    (step?: Steps): boolean => {\n      if (step?.stepType === \"entity\") {\n        return isEmpty(workflowData.selectedCompanies)\n      }\n      if (step?.stepType === \"dateFilter\") {\n        return !workflowData.selectedTimeframe || workflowData.selectedTimeframe?.end === \"\"\n      }\n      if (step?.stepType === \"sector\") {\n        return !workflowData.selectedSector\n      }\n\n      return false\n    },\n    [workflowData],\n  )\n\n  // Handle errors\n  useEffect(() => {\n    if (error) {\n      enqueueError(error.message)\n      navigate(-1)\n    }\n  }, [error, enqueueError, navigate])\n\n  useEffect(() => {\n    if (\n      workflow &&\n      workflow?.defaultDateFilter &&\n      !workflowData.selectedTimeframe?.end &&\n      workflow.behavior !== \"direct\"\n    ) {\n      setWorkflowData(prev => ({\n        ...prev,\n        selectedTimeframe: getWorkflowDefaultDateFilter(workflow),\n      }))\n    }\n  }, [workflow?.defaultDateFilter, workflowData.selectedTimeframe?.end, workflow])\n\n  // Handle direct workflow from create chat\n  useEffect(() => {\n    if (workflow?.behavior === \"direct\" || workflow?.steps?.length === 0) {\n      handleComplete()\n    }\n  }, [handleComplete, workflow?.behavior, workflow])\n\n  const renderStepContent = (step?: Steps) => {\n    if (!step) return null\n    switch (step.stepType) {\n      case \"entity\":\n        return (\n          <CompanySearchAutocomplete\n            workflowDescription={workflow?.description ?? \"\"}\n            handleCompanySelection={handleCompanySelection}\n            companies={workflowData.selectedCompanies}\n            disjunctiveFacets={workflow?.disjunctiveFacets}\n          />\n        )\n      case \"dateFilter\":\n        return (\n          <TimeframeSelector\n            timeframe={workflowData.selectedTimeframe}\n            handleTimeframeSelection={handleTimeframeSelection}\n          />\n        )\n      case \"sector\":\n        return (\n          workflow?.sectors && (\n            <SectorSelector\n              sectorsOptions={workflow?.sectors}\n              sector={workflowData?.selectedSector}\n              handleSectorSelection={handleSectorSelection}\n            />\n          )\n        )\n      case \"customInstructions\":\n        return (\n          <CustomInstructions\n            customInstructions={workflowData.customInstructions ?? \"\"}\n            handleCustomInstructionsChange={handleCustomInstructionsChange}\n          />\n        )\n      default:\n        return null\n    }\n  }\n\n  return workflow && workflow.steps && !isEmpty(workflow?.steps) ? (\n    <PageWrapperStyled>\n      <HtmlPageHead title=\"Workflow\" />\n      <BriefPageHeader onBackButtonClick={() => navigate(-1)} title={workflow?.flowName ?? \"\"} />\n      <DocumentViewerPage\n        contentContainerProps={{ style: { overflow: \"visible\" } }}\n        backTitle=\"\"\n        disableBackButton\n      >\n        <Box\n          sx={{\n            [`& .${VERTICAL_SCROLL_STEP_CLASS_NAME}`]: {\n              paddingBottom: \"32px\",\n            },\n            [`& .${VERTICAL_SCROLL_STEP_CLASS_NAME}:last-of-type`]: {\n              paddingBottom: \"120px\",\n            },\n            marginBottom: activeStep === WorkflowSteps.SELECT_COMPANIES ? \"60px\" : undefined,\n            paddingBottom: activeStep === WorkflowSteps.SELECT_COMPANIES ? \"40px\" : undefined,\n          }}\n        >\n          <VerticalScrollStepper\n            activeStep={activeStep}\n            handleComplete={handleComplete}\n            completeButtonText={\n              isLoading ? <CircularProgress size={16} color=\"inherit\" /> : \"Create\"\n            }\n            steps={workflow?.steps.length ?? 0}\n            title={workflow?.flowName ?? \"\"}\n            offsetTop={HEADER_HEIGHT}\n            nextDisabled={getNextButtonDisabled(workflow?.steps[activeStep])}\n            onStepChange={setActiveStep}\n            withKeyboardShortcuts\n          >\n            {renderStepContent(workflow?.steps[activeStep])}\n          </VerticalScrollStepper>\n        </Box>\n      </DocumentViewerPage>\n    </PageWrapperStyled>\n  ) : null\n}\n\nexport { Workflow }\n"],"names":["Workflow","workflowData","id","useParams","navigate","useNavigate","enqueueError","useSnackbar","enableCustomInstructions","useFeatureAtom","isLoading","data","workflow","error","useWorkflow","activeStep","setActiveStep","useState","WorkflowSteps","SELECT_COMPANIES","setWorkflowData","selectedCompanies","handleComplete","useCallback","defaultDateFilter","getWorkflowDefaultDateFilter","workflowState","originWorkflow","selectedData","behavior","selectedTimeframe","CHAT_ROUTE","state","replace","updateWorkflowData","updates","prev","handleCompanySelection","companies","handleTimeframeSelection","timeframe","handleSectorSelection","sector","selectedSector","handleCustomInstructionsChange","text","customInstructions","getNextButtonDisabled","step","stepType","isEmpty","end","useEffect","message","steps","length","renderStepContent","CompanySearchAutocomplete","workflowDescription","description","disjunctiveFacets","TimeframeSelector","sectors","SectorSelector","sectorsOptions","CustomInstructions","PageWrapperStyled","HtmlPageHead","title","BriefPageHeader","onBackButtonClick","flowName","DocumentViewerPage","contentContainerProps","style","overflow","backTitle","disableBackButton","Box","sx","VERTICAL_SCROLL_STEP_CLASS_NAME","paddingBottom","marginBottom","undefined","VerticalScrollStepper","completeButtonText","CircularProgress","size","color","offsetTop","HEADER_HEIGHT","nextDisabled","onStepChange","withKeyboardShortcuts"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}