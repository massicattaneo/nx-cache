{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/document-viewer/src/lib/LimitedDocumentViewer.tsx"],"sourcesContent":["import { useEffect } from \"react\"\n// Utils\nimport { getRegExpKeywords } from \"@rp/common/utils\"\n// Types\nimport { RpJsonDocument } from \"@rp/react/rpjson/types\"\nimport {\n  useEntitiesStyles,\n  useKeywordStyles,\n  useLimitedChunksStyles,\n} from \"@rp/react/web/common/document-viewer\"\nimport { useStopWatch } from \"@rp/react/web/common/hooks\"\nimport { tagManagerEvents } from \"@rp/react/web/common/vendors/utils\"\n// Components\nimport { Link, Typography, useTheme } from \"@rp/react/web/mui/core\"\nimport { RpJsonAnnotationStyles } from \"@rp/react/web/rpjson\"\nimport { getUrlWithTextFragment } from \"@rp/web/utils\"\nimport { DocumentImage } from \"./DocumentImage\"\nimport { LoadingDocumentParagraph } from \"./DocumentLoader\"\nimport { DocumentViewerHeader } from \"./DocumentViewerHeader\"\n// Styles\nimport { DocumentTextContainer, RpJsonSpotlightSentenceStyled } from \"./DocumentViewerPage.styles\"\n// Resources\nimport { useDocumentViewer } from \"./hooks/useDocumentViewer\"\n\ntype Props = {\n  rpjsonDocument: RpJsonDocument\n  namespace: \"public\" | \"private\"\n  externalContentUrl: string\n  fixedRef: HTMLDivElement | null\n  setFixedRef?: (element: HTMLDivElement | null) => void\n  documentId: string\n}\n\nconst LimitedDocumentViewer = ({\n  rpjsonDocument,\n  namespace,\n  setFixedRef,\n  externalContentUrl,\n  documentId,\n}: Props) => {\n  const theme = useTheme()\n  const { matches, documentInfo, queryId } = useDocumentViewer({\n    rpjsonDocument,\n    namespace,\n  })\n\n  const { chunks, selectedMatch, setSelectedMatch, count, isLoading: areMatchesLoading } = matches\n  const { entities, documentScope, extension, language } = documentInfo\n\n  const highlights = [\n    ...useKeywordStyles(documentInfo.keywords, \"\"),\n    ...useEntitiesStyles(entities, true),\n    ...useLimitedChunksStyles(chunks[selectedMatch]),\n  ]\n\n  useEffect(() => {\n    window.scroll({ top: 0 })\n  }, [])\n\n  // If the selected sentence is the headline, we want to use the first sentence.\n  const sentencesMerged = chunks[selectedMatch]?.sentences ?? []\n\n  const isHeadline = !sentencesMerged[0]?.pnum\n  const sentenceSpotlight = isHeadline\n    ? [\n        {\n          pnum: 1,\n          snum: 1,\n          text: \"\",\n        },\n      ]\n    : sentencesMerged\n\n  // For Google Tag Manager\n  const handleReadMoreClick = () => {\n    tagManagerEvents.documentOutbound({\n      documentId,\n      sourceName: rpjsonDocument?.document.source.name,\n      sourceId: rpjsonDocument?.document.source.rp_source_id,\n      component: \"readMore\",\n    })\n  }\n\n  // For Google Tag Manager\n  const handleLinkClick = () => {\n    tagManagerEvents.documentOutbound({\n      documentId,\n      sentenceId: `${documentId}-${sentenceSpotlight[0].pnum}-${sentenceSpotlight[0].snum}`,\n      sourceName: rpjsonDocument?.document.source.name,\n      sourceId: rpjsonDocument?.document.source.rp_source_id,\n      component: \"highlight\",\n    })\n  }\n\n  const onMatchesChange = (index: number) => {\n    setSelectedMatch(index)\n\n    // Send event to GTM\n    tagManagerEvents.documentReading({\n      documentId: rpjsonDocument.document.rp_document_id,\n      matchRead: index,\n      matchesCount: matches.count,\n      isLimited: true,\n      queryId,\n    })\n  }\n\n  // Track document reading time\n  const stopWatch = useStopWatch()\n\n  useEffect(() => {\n    stopWatch.start()\n    return () => {\n      stopWatch.stop()\n      tagManagerEvents.documentClosed({\n        documentId: rpjsonDocument.document.rp_document_id,\n        timeSpent: stopWatch.times.current.totalTime,\n        isLimited: true,\n        queryId,\n      })\n      stopWatch.reset()\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [])\n\n  const fragment = chunks[selectedMatch]?.text\n\n  return (\n    <RpJsonAnnotationStyles highlights={highlights}>\n      <div ref={setFixedRef}>\n        <DocumentViewerHeader\n          actions={{}}\n          areMatchesLoading={areMatchesLoading}\n          currentMatch={selectedMatch}\n          disableShrinking\n          documentScope={documentScope}\n          enableMatches\n          fileExtension={extension}\n          foundCount={0}\n          language={language}\n          markSentences={false}\n          matchesCount={chunks.length > 0 ? chunks.length : count}\n          namespace={namespace}\n          onArrowsClick={() => {}}\n          onMatchesChange={onMatchesChange}\n          rpjson={rpjsonDocument}\n          value=\"\"\n        />\n      </div>\n\n      {areMatchesLoading ? (\n        <LoadingDocumentParagraph />\n      ) : (\n        <DocumentTextContainer>\n          <DocumentImage\n            onClick={handleReadMoreClick}\n            documentId={documentId}\n            externalContentUrl={externalContentUrl}\n          />\n          <RpJsonSpotlightSentenceStyled\n            rpjson={rpjsonDocument}\n            sentences={sentenceSpotlight}\n            color={theme.palette.text.primary}\n            href={getUrlWithTextFragment(externalContentUrl, fragment)}\n            finds={getRegExpKeywords(documentInfo.keywords)}\n            isHeadline={isHeadline}\n            markupDetections\n            onLinkClick={handleLinkClick}\n          />\n          <Typography mt={4} component=\"div\" fontSize=\"inherit\">\n            This is a web article.{\" \"}\n            <Link\n              href={externalContentUrl}\n              color=\"primary\"\n              target=\"_blank\"\n              underline=\"hover\"\n              rel=\"noopener\"\n              onClick={handleReadMoreClick}\n            >\n              Read More.\n            </Link>\n          </Typography>\n        </DocumentTextContainer>\n      )}\n    </RpJsonAnnotationStyles>\n  )\n}\n\nexport { LimitedDocumentViewer }\n"],"names":["LimitedDocumentViewer","rpjsonDocument","namespace","setFixedRef","externalContentUrl","documentId","chunks","sentencesMerged","theme","useTheme","matches","documentInfo","queryId","useDocumentViewer","selectedMatch","setSelectedMatch","count","isLoading","areMatchesLoading","entities","documentScope","extension","language","highlights","useKeywordStyles","keywords","useEntitiesStyles","useLimitedChunksStyles","useEffect","window","scroll","top","sentences","isHeadline","pnum","sentenceSpotlight","snum","text","handleReadMoreClick","tagManagerEvents","documentOutbound","sourceName","document","source","name","sourceId","rp_source_id","component","handleLinkClick","sentenceId","onMatchesChange","index","documentReading","rp_document_id","matchRead","matchesCount","isLimited","stopWatch","useStopWatch","start","stop","documentClosed","timeSpent","times","current","totalTime","reset","fragment","RpJsonAnnotationStyles","div","ref","DocumentViewerHeader","actions","currentMatch","disableShrinking","enableMatches","fileExtension","foundCount","markSentences","length","onArrowsClick","rpjson","value","LoadingDocumentParagraph","DocumentTextContainer","DocumentImage","onClick","RpJsonSpotlightSentenceStyled","color","palette","primary","href","getUrlWithTextFragment","finds","getRegExpKeywords","markupDetections","onLinkClick","Typography","mt","fontSize","Link","target","underline","rel"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}