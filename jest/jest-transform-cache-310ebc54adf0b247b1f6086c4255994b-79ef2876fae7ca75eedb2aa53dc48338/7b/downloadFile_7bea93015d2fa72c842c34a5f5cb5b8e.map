{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/common/files/src/lib/downloadFile.ts"],"sourcesContent":["import { AxiosResponse } from \"axios\"\nimport { DownloadFormat, removeFileExtension } from \"@rp/common/utils\"\nimport { getApiEnvironmentConfig } from \"@rp/common/utils\"\nimport { axiosClient } from \"@rp/react/axios-client\"\n\nconst url = getApiEnvironmentConfig(\"text-analytics\").url\nconst queryParam = \"?status-code-override=true\"\n\nconst makeDownloadName = (name: string, format: DownloadFormat) => {\n  const fileName = removeFileExtension(name)\n\n  switch (format) {\n    case \"text-extraction\":\n      return `${fileName}.txt`\n    case \"analytics-csv\":\n      return `${fileName}.csv`\n    case \"annotated\":\n    case \"analytics-json\":\n      return `${fileName}.json`\n    default:\n      return name\n  }\n}\n\nconst generateLink = (\n  response: AxiosResponse<Blob | MediaSource, unknown>,\n  downloadName: string,\n) => {\n  const link = document.createElement(\"a\")\n\n  link.href = window.URL.createObjectURL(response.data)\n  link.target = \"_self\"\n  link.setAttribute(\"download\", downloadName)\n\n  document.body.appendChild(link)\n  link.click()\n  document.body.removeChild(link)\n}\n\nconst manualRedirect = async (redirectURL: string, downloadName: string) => {\n  axiosClient\n    .get(redirectURL, {\n      responseType: \"blob\",\n      withCredentials: false,\n    })\n    .then(secondResponse => generateLink(secondResponse, downloadName))\n}\n\nexport const downloadFile = (\n  { id, name, fileUrl }: { id: string; name: string; fileUrl?: string },\n  downloadFormat: DownloadFormat,\n) => {\n  if (!id) return\n\n  let acceptHeader: string | undefined\n  let downloadParam: string | null = downloadFormat\n\n  if (downloadFormat?.includes(\"analytics\")) {\n    const [analytics, format] = downloadFormat.split(\"-\")\n    downloadParam = analytics\n\n    if (format === \"csv\") {\n      acceptHeader = \"text/csv\"\n    } else {\n      acceptHeader = \"application/json\"\n    }\n  }\n\n  const override =\n    downloadFormat === \"annotated\" ||\n    downloadFormat === \"text-extraction\" ||\n    downloadFormat === null\n\n  const downloadLink =\n    fileUrl ??\n    `${url}/files/${id}${downloadParam ? \"/\" + downloadParam : \"\"}${override ? queryParam : \"\"}`\n  const downloadName = downloadFormat ? makeDownloadName(name, downloadFormat) : name\n\n  axiosClient\n    .get(downloadLink, {\n      headers: acceptHeader ? { accept: acceptHeader } : {},\n      responseType: override ? undefined : \"blob\",\n    })\n    .then(response => {\n      if (response.data.Location) {\n        manualRedirect(response.data.Location, downloadName)\n      } else if (response.data.url) {\n        manualRedirect(response.data.url, downloadName)\n      } else {\n        generateLink(response, downloadName)\n      }\n    })\n}\n"],"names":["downloadFile","url","getApiEnvironmentConfig","queryParam","makeDownloadName","name","format","fileName","removeFileExtension","generateLink","response","downloadName","link","document","createElement","href","window","URL","createObjectURL","data","target","setAttribute","body","appendChild","click","removeChild","manualRedirect","redirectURL","axiosClient","get","responseType","withCredentials","then","secondResponse","id","fileUrl","downloadFormat","acceptHeader","downloadParam","includes","analytics","split","override","downloadLink","headers","accept","undefined","Location"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAgDaA;;;eAAAA;;;uBA/CuC;6BAExB;AAE5B,MAAMC,MAAMC,IAAAA,8BAAuB,EAAC,kBAAkBD,GAAG;AACzD,MAAME,aAAa;AAEnB,MAAMC,mBAAmB,CAACC,MAAcC;IACtC,MAAMC,WAAWC,IAAAA,0BAAmB,EAACH;IAErC,OAAQC;QACN,KAAK;YACH,OAAO,CAAC,EAAEC,SAAS,IAAI,CAAC;QAC1B,KAAK;YACH,OAAO,CAAC,EAAEA,SAAS,IAAI,CAAC;QAC1B,KAAK;QACL,KAAK;YACH,OAAO,CAAC,EAAEA,SAAS,KAAK,CAAC;QAC3B;YACE,OAAOF;IACX;AACF;AAEA,MAAMI,eAAe,CACnBC,UACAC;IAEA,MAAMC,OAAOC,SAASC,aAAa,CAAC;IAEpCF,KAAKG,IAAI,GAAGC,OAAOC,GAAG,CAACC,eAAe,CAACR,SAASS,IAAI;IACpDP,KAAKQ,MAAM,GAAG;IACdR,KAAKS,YAAY,CAAC,YAAYV;IAE9BE,SAASS,IAAI,CAACC,WAAW,CAACX;IAC1BA,KAAKY,KAAK;IACVX,SAASS,IAAI,CAACG,WAAW,CAACb;AAC5B;AAEA,MAAMc,iBAAiB,OAAOC,aAAqBhB;IACjDiB,wBAAW,CACRC,GAAG,CAACF,aAAa;QAChBG,cAAc;QACdC,iBAAiB;IACnB,GACCC,IAAI,CAACC,CAAAA,iBAAkBxB,aAAawB,gBAAgBtB;AACzD;AAEO,MAAMX,eAAe,CAC1B,EAAEkC,EAAE,EAAE7B,IAAI,EAAE8B,OAAO,EAAkD,EACrEC;IAEA,IAAI,CAACF,IAAI;IAET,IAAIG;IACJ,IAAIC,gBAA+BF;IAEnC,IAAIA,2BAAAA,qCAAAA,eAAgBG,QAAQ,CAAC,cAAc;QACzC,MAAM,CAACC,WAAWlC,OAAO,GAAG8B,eAAeK,KAAK,CAAC;QACjDH,gBAAgBE;QAEhB,IAAIlC,WAAW,OAAO;YACpB+B,eAAe;QACjB,OAAO;YACLA,eAAe;QACjB;IACF;IAEA,MAAMK,WACJN,mBAAmB,eACnBA,mBAAmB,qBACnBA,mBAAmB;IAErB,MAAMO,eACJR,oBAAAA,qBAAAA,UACA,CAAC,EAAElC,IAAI,OAAO,EAAEiC,GAAG,EAAEI,gBAAgB,MAAMA,gBAAgB,GAAG,EAAEI,WAAWvC,aAAa,GAAG,CAAC;IAC9F,MAAMQ,eAAeyB,iBAAiBhC,iBAAiBC,MAAM+B,kBAAkB/B;IAE/EuB,wBAAW,CACRC,GAAG,CAACc,cAAc;QACjBC,SAASP,eAAe;YAAEQ,QAAQR;QAAa,IAAI,CAAC;QACpDP,cAAcY,WAAWI,YAAY;IACvC,GACCd,IAAI,CAACtB,CAAAA;QACJ,IAAIA,SAASS,IAAI,CAAC4B,QAAQ,EAAE;YAC1BrB,eAAehB,SAASS,IAAI,CAAC4B,QAAQ,EAAEpC;QACzC,OAAO,IAAID,SAASS,IAAI,CAAClB,GAAG,EAAE;YAC5ByB,eAAehB,SAASS,IAAI,CAAClB,GAAG,EAAEU;QACpC,OAAO;YACLF,aAAaC,UAAUC;QACzB;IACF;AACJ"}