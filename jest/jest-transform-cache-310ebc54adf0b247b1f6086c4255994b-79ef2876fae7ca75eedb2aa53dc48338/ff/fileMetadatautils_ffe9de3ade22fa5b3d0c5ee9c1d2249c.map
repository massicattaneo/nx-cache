{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/tanstack-api/file/src/utils/fileMetadata.utils.ts"],"sourcesContent":["import { FileCollection, FileRowType, IndexStatus } from \"@rp/common/utils\"\nimport {\n  InfiniteData,\n  Query,\n  QueryClient,\n  QueryObserverSuccessResult,\n  UseQueryResult,\n} from \"@tanstack/react-query\"\nimport { createServerFile, filesQueryKeys } from \".\"\n\nconst getIsMissingMetaData = (baseFile: FileRowType): boolean =>\n  [\"analyzing\", \"progress\", \"processing\", \"pending\"].includes(baseFile.status) &&\n  (baseFile.progress === 100 || baseFile.progress === undefined)\n\nconst getRefetchIntervalForUseFileMetadata = (\n  query: Query<\n    IndexStatus,\n    Error,\n    IndexStatus,\n    readonly [\"file\", string | undefined, \"index-status\"]\n  >,\n): number | false =>\n  query.state.data?.status === \"PENDING\" || query.state.data?.status === \"ANALYZING\" ? 1000 : false\n\nconst getHasQueryIssue = (\n  results: UseQueryResult<IndexStatus, Error>,\n  cacheSize: number | null | undefined,\n  cacheTs: string,\n): boolean =>\n  !!results.data &&\n  [\"INDEXED\", \"INDEXING_FAILED\", \"ANALYZE_FAILED\"].includes(results.data.status) &&\n  cacheSize !== null &&\n  cacheSize !== undefined &&\n  !!cacheTs\n\nconst setQueryDataClearError = (prev: FileRowType | undefined) =>\n  prev ? { ...prev, error: null } : prev\n\nconst setQueriesDataIssues = (\n  data: InfiniteData<FileCollection, unknown> | undefined,\n  results: QueryObserverSuccessResult<IndexStatus, Error>,\n  baseFile: FileRowType,\n  cacheSize: number,\n  cacheTs: string,\n) => {\n  if (!data) return data\n\n  return {\n    ...data,\n    pages: data.pages.map(page => {\n      return {\n        results: [\n          createServerFile(\n            results.data,\n            baseFile.name,\n            baseFile.id,\n            baseFile.sharedWith,\n            baseFile.owner,\n            cacheSize,\n            cacheTs,\n          ),\n          ...page.results,\n        ],\n      }\n    }),\n  }\n}\n\nconst setQueryDataIssues = (\n  currentFiles: FileCollection | undefined,\n  results: QueryObserverSuccessResult<IndexStatus, Error>,\n  baseFile: FileRowType,\n  cacheSize: number,\n  cacheTs: string,\n) => ({\n  results: [\n    ...(currentFiles?.results ?? []),\n    createServerFile(\n      results.data,\n      baseFile.name,\n      baseFile.id,\n      baseFile.sharedWith,\n      baseFile.owner,\n      cacheSize,\n      cacheTs,\n    ),\n  ],\n})\n\nconst handleEffectMissingMetadata = (\n  baseFile: FileRowType,\n  queryClient: QueryClient,\n  results: UseQueryResult<IndexStatus, Error>,\n  missingMetaData: boolean,\n) => {\n  if (results.isSuccess && results.data && missingMetaData) {\n    queryClient.setQueryData<FileRowType>(\n      filesQueryKeys.metadata(baseFile.id),\n      setQueryDataClearError,\n    )\n\n    const cacheSize = baseFile.size\n    const cacheTs = baseFile.date\n\n    if (getHasQueryIssue(results, cacheSize, cacheTs)) {\n      const queryKey = filesQueryKeys.paginated({ shared: false }).slice(0, 2)\n\n      queryClient.setQueriesData<InfiniteData<FileCollection>>({ queryKey }, data =>\n        setQueriesDataIssues(data, results, baseFile, cacheSize, cacheTs),\n      )\n\n      queryClient.refetchQueries({ queryKey })\n\n      queryClient.setQueryData<FileCollection>(filesQueryKeys.file, currentFiles =>\n        setQueryDataIssues(currentFiles, results, baseFile, cacheSize, cacheTs),\n      )\n    }\n  }\n}\n\nexport {\n  getHasQueryIssue,\n  getIsMissingMetaData,\n  getRefetchIntervalForUseFileMetadata,\n  handleEffectMissingMetadata,\n  setQueriesDataIssues,\n  setQueryDataClearError,\n  setQueryDataIssues,\n}\n"],"names":["getHasQueryIssue","getIsMissingMetaData","getRefetchIntervalForUseFileMetadata","handleEffectMissingMetadata","setQueriesDataIssues","setQueryDataClearError","setQueryDataIssues","baseFile","includes","status","progress","undefined","query","state","data","results","cacheSize","cacheTs","prev","error","pages","map","page","createServerFile","name","id","sharedWith","owner","currentFiles","queryClient","missingMetaData","isSuccess","setQueryData","filesQueryKeys","metadata","size","date","queryKey","paginated","shared","slice","setQueriesData","refetchQueries","file"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;;;;;;;;IAyHEA,gBAAgB;eAAhBA;;IACAC,oBAAoB;eAApBA;;IACAC,oCAAoC;eAApCA;;IACAC,2BAA2B;eAA3BA;;IACAC,oBAAoB;eAApBA;;IACAC,sBAAsB;eAAtBA;;IACAC,kBAAkB;eAAlBA;;;kBAvH+C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEjD,MAAML,uBAAuB,CAACM,WAC5B;QAAC;QAAa;QAAY;QAAc;KAAU,CAACC,QAAQ,CAACD,SAASE,MAAM,KAC1EF,CAAAA,SAASG,QAAQ,KAAK,OAAOH,SAASG,QAAQ,KAAKC,SAAQ;AAE9D,MAAMT,uCAAuC,CAC3CU;QAOAA,mBAA0CA;WAA1CA,EAAAA,oBAAAA,MAAMC,KAAK,CAACC,IAAI,cAAhBF,wCAAAA,kBAAkBH,MAAM,MAAK,aAAaG,EAAAA,qBAAAA,MAAMC,KAAK,CAACC,IAAI,cAAhBF,yCAAAA,mBAAkBH,MAAM,MAAK,cAAc,OAAO;;AAE9F,MAAMT,mBAAmB,CACvBe,SACAC,WACAC,UAEA,CAAC,CAACF,QAAQD,IAAI,IACd;QAAC;QAAW;QAAmB;KAAiB,CAACN,QAAQ,CAACO,QAAQD,IAAI,CAACL,MAAM,KAC7EO,cAAc,QACdA,cAAcL,aACd,CAAC,CAACM;AAEJ,MAAMZ,yBAAyB,CAACa,OAC9BA,OAAO,wCAAKA;QAAMC,OAAO;SAASD;AAEpC,MAAMd,uBAAuB,CAC3BU,MACAC,SACAR,UACAS,WACAC;IAEA,IAAI,CAACH,MAAM,OAAOA;IAElB,OAAO,wCACFA;QACHM,OAAON,KAAKM,KAAK,CAACC,GAAG,CAACC,CAAAA;YACpB,OAAO;gBACLP,SAAS;oBACPQ,IAAAA,kBAAgB,EACdR,QAAQD,IAAI,EACZP,SAASiB,IAAI,EACbjB,SAASkB,EAAE,EACXlB,SAASmB,UAAU,EACnBnB,SAASoB,KAAK,EACdX,WACAC;uBAECK,KAAKP,OAAO;iBAChB;YACH;QACF;;AAEJ;AAEA,MAAMT,qBAAqB,CACzBsB,cACAb,SACAR,UACAS,WACAC;QAGMW;WAFF;QACJb,SAAS;eACHa,CAAAA,wBAAAA,yBAAAA,mCAAAA,aAAcb,OAAO,cAArBa,mCAAAA,wBAAyB,EAAE;YAC/BL,IAAAA,kBAAgB,EACdR,QAAQD,IAAI,EACZP,SAASiB,IAAI,EACbjB,SAASkB,EAAE,EACXlB,SAASmB,UAAU,EACnBnB,SAASoB,KAAK,EACdX,WACAC;SAEH;IACH;AAAA;AAEA,MAAMd,8BAA8B,CAClCI,UACAsB,aACAd,SACAe;IAEA,IAAIf,QAAQgB,SAAS,IAAIhB,QAAQD,IAAI,IAAIgB,iBAAiB;QACxDD,YAAYG,YAAY,CACtBC,gBAAc,CAACC,QAAQ,CAAC3B,SAASkB,EAAE,GACnCpB;QAGF,MAAMW,YAAYT,SAAS4B,IAAI;QAC/B,MAAMlB,UAAUV,SAAS6B,IAAI;QAE7B,IAAIpC,iBAAiBe,SAASC,WAAWC,UAAU;YACjD,MAAMoB,WAAWJ,gBAAc,CAACK,SAAS,CAAC;gBAAEC,QAAQ;YAAM,GAAGC,KAAK,CAAC,GAAG;YAEtEX,YAAYY,cAAc,CAA+B;gBAAEJ;YAAS,GAAGvB,CAAAA,OACrEV,qBAAqBU,MAAMC,SAASR,UAAUS,WAAWC;YAG3DY,YAAYa,cAAc,CAAC;gBAAEL;YAAS;YAEtCR,YAAYG,YAAY,CAAiBC,gBAAc,CAACU,IAAI,EAAEf,CAAAA,eAC5DtB,mBAAmBsB,cAAcb,SAASR,UAAUS,WAAWC;QAEnE;IACF;AACF"}