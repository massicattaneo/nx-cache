{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/development/src/lib/trpc/text-analytics-api/text-analytics-api-router.ts"],"sourcesContent":["import { z } from \"zod\"\nimport { TRPCError } from \"@trpc/server\"\nimport { generateFile, userOwner } from \"../../database\"\nimport { generateRpJsonFromFile } from \"../../database/generators/generateRpJson\"\nimport { trpcMocks } from \"../../msw/trpcMocks\"\nimport {\n  textAnalyticsApiProcedure,\n  trpcTextAnalyticsApiServer,\n} from \"./text-analytics-api-procedure\"\n\nconst UPLOAD_PATH = \"/1.0/files-upload/:id\"\n\nexport const trpcTextAnalyticsApiRouter = trpcTextAnalyticsApiServer.router({\n  files: {\n    get: textAnalyticsApiProcedure\n      .meta({ openapi: { method: \"GET\", path: \"/1.0/files/\" } })\n      .input(\n        z.object({\n          status: z.string().optional(),\n          shared: z.boolean().optional(),\n          file_name: z.string().optional(),\n        }),\n      )\n      .query(async ({ ctx, input }) => {\n        const shared = input.shared === true\n        if (input.status === \"PROCESSING\") return { results: [] }\n        const results = (\n          await ctx.db.collection(\"files\").find(item => {\n            const sharedWith = item.file.shared_with ?? []\n            if (!shared) return item.file.owner === userOwner.ownerUserId\n            return (\n              sharedWith.includes(userOwner.organization.id) &&\n              item.file.owner !== userOwner.ownerUserId\n            )\n          })\n        )\n          .filter(item =>\n            item.file.file_name\n              .toLocaleLowerCase()\n              .includes(input.file_name?.toLocaleLowerCase() ?? \"\"),\n          )\n          .map(item => item.file)\n        return { results }\n      }),\n    post: textAnalyticsApiProcedure\n      .meta({ openapi: { method: \"POST\", path: \"/1.0/files\" } })\n      .input(z.object({ file_name: z.string() }))\n      .mutation(async ({ ctx, input }) => {\n        const file = generateFile({ name: input.file_name })\n        await ctx.db.collection(\"files\").insertOne(file)\n        const Location = `${ctx.request.url.origin}${UPLOAD_PATH.replace(\":id\", file.id)}`\n        return { Location, file_id: file.id }\n      }),\n    patch: textAnalyticsApiProcedure\n      .meta({ openapi: { method: \"PATCH\", path: \"/1.0/files\" } })\n      .input(z.object({ action: z.string(), files: z.array(z.string()) }))\n      .mutation(async ({ ctx, input }) => {\n        if (input.action === \"DELETE\") {\n          await Promise.all(input.files.map(id => ctx.db.collection(\"files\").deleteOne({ id })))\n        }\n        const data = { metadata: { total: input.files.length, success: input.files.length } }\n        return { message: \"Accepted\", data }\n      }),\n    patchMetadata: textAnalyticsApiProcedure\n      .meta({ openapi: { method: \"PATCH\", path: \"/1.0/files/:id/metadata\" } })\n      .input(z.object({ shared_with: z.array(z.string()), id: z.string() }))\n      .mutation(async ({ ctx, input }) => {\n        const file = await ctx.db.collection(\"files\").updateOne({ id: input.id }, prev => ({\n          ...prev,\n          file: { ...prev.file, shared_with: input.shared_with },\n        }))\n        return file?.file\n      }),\n    putUpload: textAnalyticsApiProcedure\n      .meta({ openapi: { method: \"PUT\", path: UPLOAD_PATH } })\n      .input(z.object({ id: z.string() }))\n      .mutation(async ({ ctx }) => {\n        const cqsItems = await ctx.db.collection(\"cqs\").find()\n        const id = ctx.request.url.pathname.split(\"/\").pop() || \"\"\n        const file = await ctx.db.collection(\"files\").updateOne({ id }, prev => {\n          const content = ctx.request.rawBody\n          const rpjson = generateRpJsonFromFile({ content, name: prev.file.file_name }, cqsItems)\n          return { ...prev, content, rpjson }\n        })\n        return file?.file\n      }),\n    getStatus: textAnalyticsApiProcedure\n      .meta({ openapi: { method: \"GET\", path: \"/1.0/files/:id/index-status\" } })\n      .input(z.object({ id: z.string() }))\n      .query(() => ({ status: \"INDEXED\" })),\n    annotated: textAnalyticsApiProcedure\n      .meta({ openapi: { method: \"GET\", path: \"/1.0/files/:id/annotated\" } })\n      .input(z.object({ id: z.string() }))\n      .query(({ input, ctx }) => {\n        return {\n          Location: `${ctx.request.url.origin}${UPLOAD_PATH.replace(\":id\", input.id)}`,\n        }\n      }),\n  },\n  quota: textAnalyticsApiProcedure\n    .meta({ openapi: { method: \"GET\", path: \"/1.0/quota\" } })\n    .query(() => trpcMocks.textAnalyticsQuota()),\n  rpjson: textAnalyticsApiProcedure\n    .meta({ openapi: { method: \"GET\", path: UPLOAD_PATH } })\n    .input(z.object({ id: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const file = await ctx.db.collection(\"files\").findOne({ id: input.id })\n      if (!file || !file.rpjson) throw new TRPCError({ code: \"NOT_FOUND\" })\n      return file.rpjson\n    }),\n})\n"],"names":["trpcTextAnalyticsApiRouter","UPLOAD_PATH","trpcTextAnalyticsApiServer","router","files","get","textAnalyticsApiProcedure","meta","openapi","method","path","input","z","object","status","string","optional","shared","boolean","file_name","query","ctx","results","db","collection","find","item","sharedWith","file","shared_with","owner","userOwner","ownerUserId","includes","organization","id","filter","toLocaleLowerCase","map","post","mutation","generateFile","name","insertOne","Location","request","url","origin","replace","file_id","patch","action","array","Promise","all","deleteOne","data","metadata","total","length","success","message","patchMetadata","updateOne","prev","putUpload","cqsItems","pathname","split","pop","content","rawBody","rpjson","generateRpJsonFromFile","getStatus","annotated","quota","trpcMocks","textAnalyticsQuota","findOne","TRPCError","code"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}