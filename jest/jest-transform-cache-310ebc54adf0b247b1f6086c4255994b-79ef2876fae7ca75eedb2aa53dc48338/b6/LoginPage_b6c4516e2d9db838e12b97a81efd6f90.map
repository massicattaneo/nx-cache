{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/apps/client-web/src/app/pages/Login/LoginPage.tsx"],"sourcesContent":["import { useEffect, useState } from \"react\"\nimport { useForm } from \"react-hook-form\"\nimport { useTranslation } from \"react-i18next\"\nimport { Link, useNavigate } from \"react-router-dom\"\nimport { z } from \"zod\"\nimport { useSignIn } from \"@clerk/clerk-react\"\nimport { isClerkAPIResponseError } from \"@clerk/clerk-react/errors\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { adapters } from \"@rp/adapters\"\nimport {\n  DEEP_LINK_TOOL_HTTPS_URL,\n  MOBILE_ONBOARDING_SCREEN_KEY,\n  displayError,\n} from \"@rp/common/utils\"\nimport { PasswordInput } from \"@rp/react/web/common/base-components\"\nimport {\n  LoginContainer,\n  SSOSignInButton,\n  SocialSignInButtons,\n} from \"@rp/react/web/common/composite-components\"\nimport { useDeviceInfo, useFromNative, useMobileNativePopup } from \"@rp/react/web/common/hooks\"\nimport { useSnackbar } from \"@rp/react/web/common/providers\"\nimport {\n  Button,\n  Divider,\n  IconButton,\n  InputLabel,\n  OutlinedInput,\n  Stack,\n  Typography,\n} from \"@rp/react/web/mui/core\"\nimport { ArrowBack } from \"@rp/react/web/mui/icons\"\nimport { RESET_PASSWORD_ROUTE, SIGN_UP_ROUTE, SSO_LOGIN_ROUTE } from \"@rp/react/web/router\"\nimport { useMutation } from \"@tanstack/react-query\"\nimport { useLoginRouteAtom } from \"../../atoms/login-route\"\nimport { MobileOnboardingPage } from \"../MobileOnboardingPage/MobileOnboardingPage\"\n\ntype Props = {\n  redirect?: string\n}\n\nfunction isSamlError(error: unknown) {\n  if (!isClerkAPIResponseError(error)) {\n    return false\n  }\n\n  return error.errors[0].longMessage?.toLowerCase().includes(\"saml\")\n}\n\ntype UseAppSignInParams = {\n  redirect?: string\n  email: string\n}\n\nfunction useAppSignIn({\n  redirect = adapters.location.getAbsoluteBaseUrl(),\n  email,\n}: UseAppSignInParams) {\n  const { signIn, setActive, isLoaded } = useSignIn()\n  const { enqueueError } = useSnackbar()\n  const navigate = useNavigate()\n\n  return useMutation({\n    mutationFn: (params: { identifier: string; password: string }) => {\n      if (!isLoaded) {\n        return Promise.reject(\"Clerk is not loaded\")\n      }\n      return signIn.create(params)\n    },\n    onSuccess: data => {\n      setActive?.({ session: data.createdSessionId })\n      window.location.replace(redirect)\n    },\n    onError: error => {\n      if (isSamlError(error)) {\n        enqueueError(\"Please log in with SSO\", {\n          anchorOrigin: { vertical: \"bottom\", horizontal: \"center\" },\n        })\n        navigate(`${SSO_LOGIN_ROUTE}/?email=${encodeURIComponent(email)}`)\n        return\n      }\n\n      enqueueError(displayError(error), {\n        anchorOrigin: { vertical: \"bottom\", horizontal: \"center\" },\n      })\n    },\n  })\n}\n\nfunction ForgotPasswordLink({ email }: { email?: string }) {\n  const params = new URLSearchParams()\n  if (email) {\n    params.set(\"email\", email)\n  }\n  return (\n    <Link to={email ? `${RESET_PASSWORD_ROUTE}/?${params.toString()}` : RESET_PASSWORD_ROUTE}>\n      Forgot your password?\n    </Link>\n  )\n}\n\nconst FormSchema = z.object({\n  identifier: z.string().email(),\n  password: z.string(),\n})\n\ntype FormValues = z.infer<typeof FormSchema>\n\nconst LoginPage = ({ redirect }: Props) => {\n  const { t } = useTranslation()\n  const { isMobile, isIOS, isAndroid } = useDeviceInfo()\n  const { isFromNative } = useFromNative()\n  const { setLoginRoute } = useLoginRouteAtom()\n  const [step, setStep] = useState<\"email\" | \"password\">(\"email\")\n  const form = useForm<FormValues>({\n    resolver: zodResolver(FormSchema),\n  })\n  const email = form.watch(\"identifier\", \"\")\n\n  const { mutate, isPending } = useAppSignIn({ redirect, email })\n\n  const { displayState, saveLSAndHideComponent } = useMobileNativePopup(\n    MOBILE_ONBOARDING_SCREEN_KEY,\n  )\n  const handleSubmit = (values: FormValues) => {\n    mutate(values)\n  }\n\n  useEffect(() => {\n    setLoginRoute(window.location.pathname)\n  }, [setLoginRoute])\n\n  return isMobile && (isIOS || isAndroid) && displayState ? (\n    <MobileOnboardingPage\n      onPressContinueWeb={saveLSAndHideComponent}\n      deepLinkURL={DEEP_LINK_TOOL_HTTPS_URL}\n    />\n  ) : (\n    <LoginContainer\n      pageTitle={t(\"loginPage.title\")}\n      title={step === \"email\" ? t(\"loginPage.title\") : t(\"loginPage.titlePassword\")}\n      hideCloseIcon\n    >\n      {step === \"password\" && (\n        <IconButton\n          onClick={() => setStep(\"email\")}\n          sx={{\n            left: isMobile ? 8 : 16,\n            top: isMobile ? 8 : 16,\n            position: \"fixed\",\n          }}\n        >\n          <ArrowBack />\n        </IconButton>\n      )}\n      <form\n        onSubmit={ev => {\n          if (step === \"email\") {\n            ev.preventDefault()\n            setStep(\"password\")\n            setTimeout(() => form.setFocus(\"password\"))\n          } else {\n            form.handleSubmit(handleSubmit)(ev)\n          }\n        }}\n        style={{\n          display: \"flex\",\n          flexDirection: \"column\",\n          gap: 24,\n          marginBottom: 24,\n          marginTop: 16,\n        }}\n      >\n        <Stack width=\"100%\">\n          <InputLabel htmlFor=\"email\" sx={{ margin: \"0 0 10px 0 !important\" }}>\n            {t(\"common.emailLabel\")}\n          </InputLabel>\n          <OutlinedInput\n            id=\"email\"\n            placeholder={t(\"common.emailPlaceholder\")}\n            {...form.register(\"identifier\")}\n          />\n        </Stack>\n\n        <Stack width=\"100%\" sx={{ display: step === \"password\" ? undefined : \"none\" }}>\n          <InputLabel htmlFor=\"password\" sx={{ margin: \"0 0 10px 0 !important\" }}>\n            Password\n          </InputLabel>\n          <PasswordInput\n            id=\"password\"\n            placeholder={t(\"common.passwordPlaceholder\")}\n            {...form.register(\"password\")}\n          />\n        </Stack>\n\n        {step === \"password\" && <ForgotPasswordLink email={email} />}\n\n        <Button\n          variant=\"contained\"\n          sx={{ fontSize: 16 }}\n          type=\"submit\"\n          fullWidth\n          disabled={isPending}\n        >\n          {t(\"common.continueButtonLowercase\")}\n        </Button>\n      </form>\n      {step === \"email\" && !isFromNative && (\n        <>\n          <Divider sx={{ mb: 3, width: \"100%\" }}>\n            <Typography variant=\"subtitle2\" sx={{ color: \"text.secondary\" }}>\n              or\n            </Typography>\n          </Divider>\n          <SocialSignInButtons />\n          <SSOSignInButton email={email} />\n        </>\n      )}\n      <Typography mt={3} fontSize=\"16px\" color=\"text.secondary\">\n        {t(\"loginPage.noAccount\")}\n        {\"   \"}\n        <Link to={`${SIGN_UP_ROUTE}${window.location.search}`}>{t(\"loginPage.signUp\")}</Link>\n      </Typography>\n    </LoginContainer>\n  )\n}\n\nexport { LoginPage }\n"],"names":["LoginPage","isSamlError","error","isClerkAPIResponseError","errors","longMessage","toLowerCase","includes","useAppSignIn","redirect","adapters","location","getAbsoluteBaseUrl","email","signIn","setActive","isLoaded","useSignIn","enqueueError","useSnackbar","navigate","useNavigate","useMutation","mutationFn","params","Promise","reject","create","onSuccess","data","session","createdSessionId","window","replace","onError","anchorOrigin","vertical","horizontal","SSO_LOGIN_ROUTE","encodeURIComponent","displayError","ForgotPasswordLink","URLSearchParams","set","Link","to","RESET_PASSWORD_ROUTE","toString","FormSchema","z","object","identifier","string","password","t","useTranslation","isMobile","isIOS","isAndroid","useDeviceInfo","isFromNative","useFromNative","setLoginRoute","useLoginRouteAtom","step","setStep","useState","form","useForm","resolver","zodResolver","watch","mutate","isPending","displayState","saveLSAndHideComponent","useMobileNativePopup","MOBILE_ONBOARDING_SCREEN_KEY","handleSubmit","values","useEffect","pathname","MobileOnboardingPage","onPressContinueWeb","deepLinkURL","DEEP_LINK_TOOL_HTTPS_URL","LoginContainer","pageTitle","title","hideCloseIcon","IconButton","onClick","sx","left","top","position","ArrowBack","onSubmit","ev","preventDefault","setTimeout","setFocus","style","display","flexDirection","gap","marginBottom","marginTop","Stack","width","InputLabel","htmlFor","margin","OutlinedInput","id","placeholder","register","undefined","PasswordInput","Button","variant","fontSize","type","fullWidth","disabled","Divider","mb","Typography","color","SocialSignInButtons","SSOSignInButton","mt","SIGN_UP_ROUTE","search"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}