{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/development/src/lib/trpc/chat-ws-api/chatWebsocketApi.ts"],"sourcesContent":["import { z } from \"zod\"\nimport { bigdataSchemas } from \"@rp/common/contracts\"\nimport { JsonDb } from \"@rp/common/json-db\"\nimport { EmptyDbDefaultData } from \"../../../database\"\nimport { AGENT_CHAT_RESPONSES } from \"./agentWebSocketApi\"\nimport { CHAT_RESPONSES, ChatPrompt } from \"./chatApiResponses\"\n\ntype Props = {\n  db: JsonDb<EmptyDbDefaultData>\n}\n\nconst validWsRequestSchema = z.union([\n  bigdataSchemas.st_llm_chat_ChatWithMemoryRequest,\n  bigdataSchemas.st_agents_AgentExecuteRequest,\n])\n\nexport const chatWebsocketApi = ({ db }: Props) => ({\n  onMessage: async (message: string) => {\n    const cqsItems = await db.collection(\"cqs\").find()\n    const files = await db.collection(\"files\").find()\n    //   requests.chatWebsocket.push({ action, inputMessage, chatId, requestId, tracking })\n    const request = validWsRequestSchema.parse(JSON.parse(message))\n    if (\n      request.action === \"ChatWithMemoryUpdateLastRequest\" ||\n      request.action === \"ChatWithMemoryRequest\"\n    ) {\n      const request = bigdataSchemas.st_llm_chat_ChatWithMemoryRequest.parse(JSON.parse(message))\n      const { inputMessage, chatId, requestId, entities } = request\n      const generateChat = CHAT_RESPONSES[inputMessage] ?? CHAT_RESPONSES[ChatPrompt.DEFAULT]\n      const obj = await generateChat({ inputMessage, requestId, cqsItems, files, entities })\n      const { interaction, messages } = obj\n      const chat = await db.collection(\"chats\").findOne({ id: chatId })\n      await db.collection(\"chats\").updateOne(\n        { id: chatId },\n        {\n          interactions: [...(chat?.interactions ?? []), interaction],\n        },\n      )\n      return { messages, request }\n    }\n\n    if (request.action === \"AgentExecuteRequest\") {\n      const request = bigdataSchemas.st_agents_AgentExecuteRequest.parse(JSON.parse(message))\n      const { inputMessage, requestId } = request\n      const generateAgentChat = AGENT_CHAT_RESPONSES[inputMessage]\n      const { messages } = await generateAgentChat({ inputMessage, requestId })\n      return { messages, request }\n    }\n\n    return { messages: [], request }\n  },\n})\n"],"names":["chatWebsocketApi","validWsRequestSchema","z","union","bigdataSchemas","st_llm_chat_ChatWithMemoryRequest","st_agents_AgentExecuteRequest","db","onMessage","message","cqsItems","collection","find","files","request","parse","JSON","action","inputMessage","chatId","requestId","entities","CHAT_RESPONSES","generateChat","ChatPrompt","DEFAULT","obj","interaction","messages","chat","findOne","id","updateOne","interactions","generateAgentChat","AGENT_CHAT_RESPONSES"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAgBaA;;;eAAAA;;;qBAhBK;2BACa;mCAGM;kCACM;AAM3C,MAAMC,uBAAuBC,MAAC,CAACC,KAAK,CAAC;IACnCC,yBAAc,CAACC,iCAAiC;IAChDD,yBAAc,CAACE,6BAA6B;CAC7C;AAEM,MAAMN,mBAAmB,CAAC,EAAEO,EAAE,EAAS,GAAM,CAAA;QAClDC,WAAW,OAAOC;YAChB,MAAMC,WAAW,MAAMH,GAAGI,UAAU,CAAC,OAAOC,IAAI;YAChD,MAAMC,QAAQ,MAAMN,GAAGI,UAAU,CAAC,SAASC,IAAI;YAC/C,uFAAuF;YACvF,MAAME,UAAUb,qBAAqBc,KAAK,CAACC,KAAKD,KAAK,CAACN;YACtD,IACEK,QAAQG,MAAM,KAAK,qCACnBH,QAAQG,MAAM,KAAK,yBACnB;gBACA,MAAMH,UAAUV,yBAAc,CAACC,iCAAiC,CAACU,KAAK,CAACC,KAAKD,KAAK,CAACN;gBAClF,MAAM,EAAES,YAAY,EAAEC,MAAM,EAAEC,SAAS,EAAEC,QAAQ,EAAE,GAAGP;oBACjCQ;gBAArB,MAAMC,eAAeD,CAAAA,+BAAAA,gCAAc,CAACJ,aAAa,cAA5BI,0CAAAA,+BAAgCA,gCAAc,CAACE,4BAAU,CAACC,OAAO,CAAC;gBACvF,MAAMC,MAAM,MAAMH,aAAa;oBAAEL;oBAAcE;oBAAWV;oBAAUG;oBAAOQ;gBAAS;gBACpF,MAAM,EAAEM,WAAW,EAAEC,QAAQ,EAAE,GAAGF;gBAClC,MAAMG,OAAO,MAAMtB,GAAGI,UAAU,CAAC,SAASmB,OAAO,CAAC;oBAAEC,IAAIZ;gBAAO;oBAIxCU;gBAHvB,MAAMtB,GAAGI,UAAU,CAAC,SAASqB,SAAS,CACpC;oBAAED,IAAIZ;gBAAO,GACb;oBACEc,cAAc;2BAAKJ,CAAAA,qBAAAA,iBAAAA,2BAAAA,KAAMI,YAAY,cAAlBJ,gCAAAA,qBAAsB,EAAE;wBAAGF;qBAAY;gBAC5D;gBAEF,OAAO;oBAAEC;oBAAUd;gBAAQ;YAC7B;YAEA,IAAIA,QAAQG,MAAM,KAAK,uBAAuB;gBAC5C,MAAMH,UAAUV,yBAAc,CAACE,6BAA6B,CAACS,KAAK,CAACC,KAAKD,KAAK,CAACN;gBAC9E,MAAM,EAAES,YAAY,EAAEE,SAAS,EAAE,GAAGN;gBACpC,MAAMoB,oBAAoBC,uCAAoB,CAACjB,aAAa;gBAC5D,MAAM,EAAEU,QAAQ,EAAE,GAAG,MAAMM,kBAAkB;oBAAEhB;oBAAcE;gBAAU;gBACvE,OAAO;oBAAEQ;oBAAUd;gBAAQ;YAC7B;YAEA,OAAO;gBAAEc,UAAU,EAAE;gBAAEd;YAAQ;QACjC;IACF,CAAA"}