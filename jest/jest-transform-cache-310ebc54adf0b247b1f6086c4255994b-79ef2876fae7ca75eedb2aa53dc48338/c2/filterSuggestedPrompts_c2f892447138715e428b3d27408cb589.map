{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/common/hooks/src/lib/useSuggestedPrompts/filterSuggestedPrompts.tsx"],"sourcesContent":["import { isSuggestedPromptDataset } from \"@rp/common/api-types\"\nimport { getEntitlementsForPrompt } from \"./getEntitlementsForPrompt\"\nimport { Filters, PromptFile, SuggestedPromptsData } from \"./suggestedPrompts.types\"\nimport { getTaskMap } from \"./taskMap\"\n\nexport const filterSuggestedPrompts = (\n  data: PromptFile,\n  filters: Filters | undefined,\n): SuggestedPromptsData => {\n  const datasets = filters ? filters.datasets : undefined\n  const textFilter = filters ? filters.textFilter : undefined\n  const includeTopics = filters ? filters.includeTopics : undefined\n  const watchlistPrompts = filters ? filters.watchlistPrompts : false\n  const includeTask = filters ? filters.includeTask : undefined\n  const includeScopes = filters ? filters.includeScopes : undefined\n  const includeDatasets = filters ? filters.includeDatasets : undefined\n  const hasEntitlement = filters ? filters.hasEntitlement : undefined\n  const isFreeTierEnabled = filters ? filters.isFreeTierEnabled : undefined\n  const today = filters?.timestamp ? filters.timestamp : Date.now()\n\n  const topics = data.topics\n  const prompts = data.prompts\n\n  let filteredResults = prompts\n\n  if (hasEntitlement && !isFreeTierEnabled) {\n    filteredResults = filteredResults.filter(prompt => {\n      const requiredEntitlements = getEntitlementsForPrompt(prompt)\n      return requiredEntitlements.every(entitlement => hasEntitlement(entitlement))\n    })\n  }\n\n  if (includeDatasets) {\n    filteredResults = filteredResults.filter(suggestion =>\n      includeDatasets.some(dataset => suggestion.datasets[dataset]),\n    )\n  }\n\n  if (watchlistPrompts) {\n    filteredResults = filteredResults.filter(suggestion => !!suggestion.watchlist)\n  }\n  // TODO try remove this\n  if (datasets) {\n    filteredResults = filteredResults.filter(suggestion =>\n      datasets.every(dataset => suggestion.datasets[dataset]),\n    )\n  }\n\n  if (textFilter !== undefined && textFilter.length > 0) {\n    filteredResults = filteredResults.filter(\n      prompt =>\n        prompt.title.toLowerCase().includes(textFilter.toLowerCase()) ||\n        prompt.relatedTopics.some(topic =>\n          topic.toLowerCase().includes(textFilter.toLowerCase()),\n        ) ||\n        prompt.task.toLowerCase().includes(textFilter.toLowerCase()),\n    )\n  }\n\n  if (\n    includeTopics !== undefined &&\n    Object.keys(includeTopics).length > 0 &&\n    !Object.values(includeTopics).every(value => !value)\n  ) {\n    filteredResults = filteredResults.filter(prompt =>\n      prompt.relatedTopics.some(topic => includeTopics[topic]),\n    )\n  }\n\n  if (\n    includeTask !== undefined &&\n    Object.keys(includeTask).length > 0 &&\n    !Object.values(includeTask).every(value => !value)\n  ) {\n    filteredResults = filteredResults.filter(prompt => includeTask[prompt.task])\n  }\n\n  if (\n    includeScopes !== undefined &&\n    Object.keys(includeScopes).length > 0 &&\n    !Object.values(includeScopes).every(value => !value)\n  ) {\n    const mapped = Object.entries(includeScopes)\n      .filter(([_, value]) => value)\n      .map(([key]) => key)\n\n    filteredResults = filteredResults.filter(prompt => {\n      return mapped.some(scope => {\n        return scope && isSuggestedPromptDataset(scope) ? prompt.datasets[scope] : false\n      })\n    })\n  }\n\n  return {\n    topics,\n    prompts: filteredResults\n      .filter(prompt => {\n        if (!prompt.validity) return true\n        if (!prompt.validity.from && prompt.validity.to)\n          return today <= new Date(prompt.validity.to).getTime()\n        if (prompt.validity.from && !prompt.validity.to)\n          return today >= new Date(prompt.validity.from).getTime()\n        if (prompt.validity.from && prompt.validity.to)\n          return (\n            today >= new Date(prompt.validity.from).getTime() &&\n            today <= new Date(prompt.validity.to).getTime()\n          )\n        return true\n      })\n      .map(suggestion => {\n        const requiredEntitlements = getEntitlementsForPrompt(suggestion)\n        const isBlocked = hasEntitlement\n          ? !requiredEntitlements.every(entitlement => hasEntitlement(entitlement))\n          : false\n\n        return {\n          id: suggestion.id,\n          icon: getTaskMap(suggestion.task),\n          label: suggestion.title,\n          prompt: suggestion.prompt,\n          relatedTopics: suggestion.relatedTopics,\n          scope: suggestion.scope,\n          blocked: isBlocked,\n          entitlements: requiredEntitlements,\n          watchlist: suggestion.watchlist ?? false,\n        }\n      }),\n  }\n}\n"],"names":["filterSuggestedPrompts","data","filters","datasets","undefined","textFilter","includeTopics","watchlistPrompts","includeTask","includeScopes","includeDatasets","hasEntitlement","isFreeTierEnabled","today","timestamp","Date","now","topics","prompts","filteredResults","filter","prompt","requiredEntitlements","getEntitlementsForPrompt","every","entitlement","suggestion","some","dataset","watchlist","length","title","toLowerCase","includes","relatedTopics","topic","task","Object","keys","values","value","mapped","entries","_","map","key","scope","isSuggestedPromptDataset","validity","from","to","getTime","isBlocked","id","icon","getTaskMap","label","blocked","entitlements"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}