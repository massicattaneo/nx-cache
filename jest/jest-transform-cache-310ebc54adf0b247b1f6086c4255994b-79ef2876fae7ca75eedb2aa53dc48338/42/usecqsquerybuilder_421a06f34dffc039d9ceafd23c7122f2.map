{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/cqs-query-context/src/lib/use-cqs-query-builder.tsx"],"sourcesContent":["import { useCallback, useEffect, useState } from \"react\"\nimport { isRpqlFlatArrayFilter, isRpqlFlatMatchFilter } from \"@rp/common/api-types\"\nimport { RpqlFilterMap, RpqlFlatFilter } from \"@rp/common/api-types\"\nimport { generateMapBuilder, getFilterFromMap } from \"@rp/react/rpql\"\nimport { FilterItem } from \"@rp/react/tanstack-api/cqs-query-context\"\nimport { EnhancedSuggestion } from \"@rp/react/tanstack-api/suggestion\"\nimport {\n  DEFAULT_OPERATION,\n  ExtendedArrayOperations,\n  convertItemToFilter,\n} from \"./convert-item-to-filter/convertItemToFilter\"\nimport {\n  convertSuggestionItem,\n  mergeMacroSearches,\n} from \"./cqs-query-context-utils/cqs-query-context-utils\"\nimport { matchFilter } from \"./match-filter/matchFilter\"\nimport { isMacroSearchItem } from \"./type-guards\"\n\nconst defaultFilter: RpqlFilterMap = {\n  root: {\n    id: \"root\",\n    type: \"and\",\n    value: [],\n  },\n}\n\nconst addCqsQueryItem = (\n  root: string,\n  builder: ReturnType<ReturnType<typeof generateMapBuilder>>,\n  item: FilterItem,\n  operation: ExtendedArrayOperations = DEFAULT_OPERATION,\n  filterMap?: RpqlFilterMap,\n) => {\n  const isCorrectFilter = matchFilter(item, operation)\n  const parent = builder.findChild(isCorrectFilter)\n  if (parent === null) {\n    builder.add(root, convertItemToFilter(item, operation))\n  } else if (isRpqlFlatMatchFilter(parent) && isMacroSearchItem(item)) {\n    const map = filterMap ?? builder.getFilterMap()\n    const getFilter = <TFilter extends RpqlFlatFilter = RpqlFlatFilter>(id: string) =>\n      getFilterFromMap<TFilter>(id, map)\n    mergeMacroSearches(builder, getFilter, parent, item)\n  } else if (\n    isRpqlFlatArrayFilter(parent) &&\n    !isMacroSearchItem(item) &&\n    !parent.value.includes(item.value)\n  ) {\n    builder.update<typeof parent>(parent.id, filter => {\n      const value = [...filter.value, item.value]\n      return { ...filter, value }\n    })\n  }\n}\n\nconst useCqsQueryBuilder = (initialTopics: Array<EnhancedSuggestion>) => {\n  const [initial] = useState(initialTopics)\n\n  const build = useCallback((topics: Array<EnhancedSuggestion>) => {\n    const builder = generateMapBuilder(\"root\", defaultFilter, () => {})\n    const builderInstance = builder()\n    topics.forEach(topic => {\n      addCqsQueryItem(\"root\", builderInstance, convertSuggestionItem(topic))\n    })\n    return { expression: builderInstance.generate() }\n  }, [])\n\n  useEffect(() => {\n    build(initial)\n  }, [initial, build])\n\n  return { build }\n}\n\nexport { useCqsQueryBuilder, addCqsQueryItem }\n"],"names":["addCqsQueryItem","useCqsQueryBuilder","defaultFilter","root","id","type","value","builder","item","operation","DEFAULT_OPERATION","filterMap","isCorrectFilter","matchFilter","parent","findChild","add","convertItemToFilter","isRpqlFlatMatchFilter","isMacroSearchItem","map","getFilterMap","getFilter","getFilterFromMap","mergeMacroSearches","isRpqlFlatArrayFilter","includes","update","filter","initialTopics","initial","useState","build","useCallback","topics","generateMapBuilder","builderInstance","forEach","topic","convertSuggestionItem","expression","generate","useEffect"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;;;;;;;;IAyE6BA,eAAe;eAAfA;;IAApBC,kBAAkB;eAAlBA;;;uBAzEwC;0BACY;sBAER;qCAO9C;sCAIA;6BACqB;4BACM;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAElC,MAAMC,gBAA+B;IACnCC,MAAM;QACJC,IAAI;QACJC,MAAM;QACNC,OAAO,EAAE;IACX;AACF;AAEA,MAAMN,kBAAkB,CACtBG,MACAI,SACAC,MACAC,YAAqCC,sCAAiB,EACtDC;IAEA,MAAMC,kBAAkBC,IAAAA,wBAAW,EAACL,MAAMC;IAC1C,MAAMK,SAASP,QAAQQ,SAAS,CAACH;IACjC,IAAIE,WAAW,MAAM;QACnBP,QAAQS,GAAG,CAACb,MAAMc,IAAAA,wCAAmB,EAACT,MAAMC;IAC9C,OAAO,IAAIS,IAAAA,+BAAqB,EAACJ,WAAWK,IAAAA,6BAAiB,EAACX,OAAO;QACnE,MAAMY,MAAMT,sBAAAA,uBAAAA,YAAaJ,QAAQc,YAAY;QAC7C,MAAMC,YAAY,CAAkDlB,KAClEmB,IAAAA,sBAAgB,EAAUnB,IAAIgB;QAChCI,IAAAA,wCAAkB,EAACjB,SAASe,WAAWR,QAAQN;IACjD,OAAO,IACLiB,IAAAA,+BAAqB,EAACX,WACtB,CAACK,IAAAA,6BAAiB,EAACX,SACnB,CAACM,OAAOR,KAAK,CAACoB,QAAQ,CAAClB,KAAKF,KAAK,GACjC;QACAC,QAAQoB,MAAM,CAAgBb,OAAOV,EAAE,EAAEwB,CAAAA;YACvC,MAAMtB,QAAQ;mBAAIsB,OAAOtB,KAAK;gBAAEE,KAAKF,KAAK;aAAC;YAC3C,OAAO,wCAAKsB;gBAAQtB;;QACtB;IACF;AACF;AAEA,MAAML,qBAAqB,CAAC4B;IAC1B,MAAM,CAACC,QAAQ,GAAGC,IAAAA,eAAQ,EAACF;IAE3B,MAAMG,QAAQC,IAAAA,kBAAW,EAAC,CAACC;QACzB,MAAM3B,UAAU4B,IAAAA,wBAAkB,EAAC,QAAQjC,eAAe,KAAO;QACjE,MAAMkC,kBAAkB7B;QACxB2B,OAAOG,OAAO,CAACC,CAAAA;YACbtC,gBAAgB,QAAQoC,iBAAiBG,IAAAA,2CAAqB,EAACD;QACjE;QACA,OAAO;YAAEE,YAAYJ,gBAAgBK,QAAQ;QAAG;IAClD,GAAG,EAAE;IAELC,IAAAA,gBAAS,EAAC;QACRV,MAAMF;IACR,GAAG;QAACA;QAASE;KAAM;IAEnB,OAAO;QAAEA;IAAM;AACjB"}