{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/common/utils/src/lib/xhrSource.ts"],"sourcesContent":["// Inspired from: https://solovyov.net/blog/2023/eventsource-post/\nimport { Method } from \"axios\"\n\n// Get the data out of an chunk of text\n// event: \"delta\" (We are ignoring this for now)\n// data: {\"name\": \"John\"} -> {\"name\": \"John\"}\nfunction sseEvent(message: string) {\n  let start = 0\n  if (message.startsWith(\"event: \")) {\n    start = message.indexOf(\"\\n\")\n  }\n  start = message.indexOf(\": \", start) + 2\n  const data = message.slice(start, message.length)\n  return new MessageEvent(\"message\", { data: data })\n}\n\ntype Options = {\n  method?: Method\n  headers?: Record<string, string>\n  timeout?: number\n  body?: XMLHttpRequestBodyInit\n}\n\ntype ExtendedEventTarget = EventTarget & { close: () => void }\n\nfunction XHRSource(url: string, opts: Options) {\n  const eventTarget = new EventTarget() as ExtendedEventTarget\n  const xhr = new XMLHttpRequest()\n\n  xhr.open(opts.method ?? \"GET\", url, true)\n  for (const key in opts.headers) {\n    xhr.setRequestHeader(key, opts.headers[key])\n  }\n\n  let ongoing = false\n  let start = 0\n\n  xhr.onloadstart = () => {\n    if (!ongoing) {\n      ongoing = true\n      eventTarget.dispatchEvent(new Event(\"open\"))\n    }\n  }\n\n  xhr.onprogress = () => {\n    let i = xhr.responseText.indexOf(\"\\r\\n\", start)\n    let chunk = undefined\n\n    while (i >= 0) {\n      chunk = xhr.responseText.slice(start, i)\n      start = i + 2\n      if (chunk.length) {\n        eventTarget.dispatchEvent(sseEvent(chunk))\n      }\n      i = xhr.responseText.indexOf(\"\\r\\n\", start)\n    }\n  }\n\n  xhr.onloadend = () => {\n    eventTarget.dispatchEvent(new CloseEvent(xhr.status >= 400 ? \"error\" : \"close\"))\n  }\n\n  xhr.timeout = opts.timeout ?? 0\n  xhr.ontimeout = () => {\n    eventTarget.dispatchEvent(new CloseEvent(\"error\", { reason: \"Network request timed out\" }))\n  }\n\n  xhr.onerror = () => {\n    eventTarget.dispatchEvent(\n      new CloseEvent(\"error\", { reason: xhr.responseText ?? \"Network request failed\" }),\n    )\n  }\n\n  xhr.onabort = () => {\n    eventTarget.dispatchEvent(new CloseEvent(\"close\", { reason: \"Network request aborted\" }))\n  }\n\n  eventTarget.close = () => {\n    xhr.abort()\n  }\n\n  function send() {\n    xhr.send(opts.body)\n  }\n\n  return { eventTarget, send }\n}\n\nexport { XHRSource }\n"],"names":["XHRSource","sseEvent","message","start","startsWith","indexOf","data","slice","length","MessageEvent","url","opts","eventTarget","EventTarget","xhr","XMLHttpRequest","open","method","key","headers","setRequestHeader","ongoing","onloadstart","dispatchEvent","Event","onprogress","i","responseText","chunk","undefined","onloadend","CloseEvent","status","timeout","ontimeout","reason","onerror","onabort","close","abort","send","body"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAAA,kEAAkE;;;;;+BAwFzDA;;;eAAAA;;;AArFT,uCAAuC;AACvC,gDAAgD;AAChD,6CAA6C;AAC7C,SAASC,SAASC,OAAe;IAC/B,IAAIC,QAAQ;IACZ,IAAID,QAAQE,UAAU,CAAC,YAAY;QACjCD,QAAQD,QAAQG,OAAO,CAAC;IAC1B;IACAF,QAAQD,QAAQG,OAAO,CAAC,MAAMF,SAAS;IACvC,MAAMG,OAAOJ,QAAQK,KAAK,CAACJ,OAAOD,QAAQM,MAAM;IAChD,OAAO,IAAIC,aAAa,WAAW;QAAEH,MAAMA;IAAK;AAClD;AAWA,SAASN,UAAUU,GAAW,EAAEC,IAAa;IAC3C,MAAMC,cAAc,IAAIC;IACxB,MAAMC,MAAM,IAAIC;QAEPJ;IAATG,IAAIE,IAAI,CAACL,CAAAA,eAAAA,KAAKM,MAAM,cAAXN,0BAAAA,eAAe,OAAOD,KAAK;IACpC,IAAK,MAAMQ,OAAOP,KAAKQ,OAAO,CAAE;QAC9BL,IAAIM,gBAAgB,CAACF,KAAKP,KAAKQ,OAAO,CAACD,IAAI;IAC7C;IAEA,IAAIG,UAAU;IACd,IAAIlB,QAAQ;IAEZW,IAAIQ,WAAW,GAAG;QAChB,IAAI,CAACD,SAAS;YACZA,UAAU;YACVT,YAAYW,aAAa,CAAC,IAAIC,MAAM;QACtC;IACF;IAEAV,IAAIW,UAAU,GAAG;QACf,IAAIC,IAAIZ,IAAIa,YAAY,CAACtB,OAAO,CAAC,QAAQF;QACzC,IAAIyB,QAAQC;QAEZ,MAAOH,KAAK,EAAG;YACbE,QAAQd,IAAIa,YAAY,CAACpB,KAAK,CAACJ,OAAOuB;YACtCvB,QAAQuB,IAAI;YACZ,IAAIE,MAAMpB,MAAM,EAAE;gBAChBI,YAAYW,aAAa,CAACtB,SAAS2B;YACrC;YACAF,IAAIZ,IAAIa,YAAY,CAACtB,OAAO,CAAC,QAAQF;QACvC;IACF;IAEAW,IAAIgB,SAAS,GAAG;QACdlB,YAAYW,aAAa,CAAC,IAAIQ,WAAWjB,IAAIkB,MAAM,IAAI,MAAM,UAAU;IACzE;QAEcrB;IAAdG,IAAImB,OAAO,GAAGtB,CAAAA,gBAAAA,KAAKsB,OAAO,cAAZtB,2BAAAA,gBAAgB;IAC9BG,IAAIoB,SAAS,GAAG;QACdtB,YAAYW,aAAa,CAAC,IAAIQ,WAAW,SAAS;YAAEI,QAAQ;QAA4B;IAC1F;IAEArB,IAAIsB,OAAO,GAAG;YAEwBtB;QADpCF,YAAYW,aAAa,CACvB,IAAIQ,WAAW,SAAS;YAAEI,QAAQrB,CAAAA,oBAAAA,IAAIa,YAAY,cAAhBb,+BAAAA,oBAAoB;QAAyB;IAEnF;IAEAA,IAAIuB,OAAO,GAAG;QACZzB,YAAYW,aAAa,CAAC,IAAIQ,WAAW,SAAS;YAAEI,QAAQ;QAA0B;IACxF;IAEAvB,YAAY0B,KAAK,GAAG;QAClBxB,IAAIyB,KAAK;IACX;IAEA,SAASC;QACP1B,IAAI0B,IAAI,CAAC7B,KAAK8B,IAAI;IACpB;IAEA,OAAO;QAAE7B;QAAa4B;IAAK;AAC7B"}