{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/cqs-query-bar/src/lib/chips/ArrayFilterChip.tsx"],"sourcesContent":["import { Fragment, MouseEvent, forwardRef, useState } from \"react\"\nimport { RpqlFlatArrayFilter } from \"@rp/common/api-types\"\nimport { FilterItem } from \"@rp/react/tanstack-api/cqs-query-context\"\nimport { useDisableIOSTouch } from \"@rp/react/web/common/hooks\"\nimport { tagManagerEvents } from \"@rp/react/web/common/vendors/utils\"\nimport { QueryIcon } from \"@rp/react/web/icons\"\nimport { NameDisplay } from \"../NameDisplay\"\nimport { CqsQueryBarContext } from \"../cqs-query-bar.types\"\nimport { AdvancedDropdown } from \"../dropdowns/AdvancedDropdown\"\nimport { entityTypeList } from \"../typeHelper\"\nimport { BaseChip } from \"./BaseChip\"\nimport { ChipLabel, PopoverStyled, Separator, TotalDisplay } from \"./Chip.styles\"\n\ntype ArrayFilterChipProps = {\n  filter: RpqlFlatArrayFilter\n  onRemove?: () => void\n  query?: CqsQueryBarContext\n}\n\nconst iconMap: Record<string, string> = {\n  language: \"LANG\",\n  rp_topic: \"EVNT\",\n  source: \"SRCE\",\n  keyword: \"keyword\",\n}\n\nconst ArrayFilterChip = forwardRef<HTMLDivElement, ArrayFilterChipProps>(\n  ({ filter, onRemove, query }, ref) => {\n    const [anchorEl, setAnchorEl] = useState<HTMLElement | null>(null)\n\n    const open = Boolean(anchorEl)\n\n    useDisableIOSTouch(open)\n\n    const total = filter.value.length\n\n    const icon: entityTypeList = (filter.metadata?.subType ??\n      iconMap[filter.type] ??\n      \"\") as entityTypeList\n\n    const handleClick = (event: MouseEvent<HTMLElement>) => {\n      setAnchorEl(event.currentTarget)\n    }\n\n    const handleClose = () => {\n      setAnchorEl(null)\n    }\n\n    const handleRemoveItem = (id: string) => {\n      handleClose()\n\n      tagManagerEvents.queryRefinement({\n        action: \"remove\",\n        component: \"queryBar\",\n        queryId: query?.id ?? \"\",\n        queryType: filter.type,\n        savedStatus: query?.saveStatus ?? \"unsaved\",\n      })\n\n      // If the filter is a keyword and it has only one value, remove the filter\n      if (filter.type === \"keyword\" && filter.value.length === 1) {\n        onRemove?.()\n        return\n      }\n\n      query?.actions.expression.updateFilter<typeof filter>(filter.id, filter => {\n        if (!Array.isArray(filter.value)) {\n          return filter\n        }\n        return {\n          ...filter,\n          value: filter.value.filter(currentId => currentId !== id),\n        }\n      })\n    }\n\n    const handleOperationChange = (operation: string) => {\n      const items: Array<FilterItem> = Array.isArray(filter.value)\n        ? filter.value.map(value => ({\n            type: filter.type,\n            value,\n            entityType: filter?.metadata?.subType,\n            operation,\n          }))\n        : [\n            {\n              type: filter.type,\n              value: filter.value,\n              entityType: filter?.metadata?.subType,\n              operation,\n            },\n          ]\n\n      tagManagerEvents.queryRefinement({\n        action: \"changeOperation\",\n        component: \"queryBar\",\n        queryId: query?.id ?? \"\",\n        queryType: filter.type,\n        savedStatus: query?.saveStatus ?? \"unsaved\",\n      })\n\n      query?.actions.expression.updateItems(filter.id, items)\n    }\n\n    const handleIndividuallyOperation = (operation: string, entityId: string) => {\n      const items: Array<FilterItem> = Array.isArray(filter.value)\n        ? filter.value.map(value => ({\n            type: filter.type,\n            value,\n            entityType: filter?.metadata?.subType,\n            operation: value === entityId ? operation : filter.operation,\n          }))\n        : [\n            {\n              type: filter.type,\n              value: filter.value,\n              entityType: filter?.metadata?.subType,\n              operation,\n            },\n          ]\n\n      tagManagerEvents.queryRefinement({\n        action: \"changeOperation\",\n        component: \"queryBar\",\n        queryId: query?.id ?? \"\",\n        queryType: filter.type,\n        savedStatus: query?.saveStatus ?? \"unsaved\",\n      })\n\n      query?.actions.expression.updateItems(filter.id, items)\n    }\n\n    return (\n      <>\n        <BaseChip\n          clickable\n          icon={<QueryIcon icon={icon} />}\n          onClick={handleClick}\n          onRemove={onRemove}\n          selected={query && open}\n          ref={ref}\n        >\n          <ChipLabel>\n            {filter.value.map((id, index) => (\n              <Fragment key={`fragment-${filter.id}-${id}`}>\n                <NameDisplay filterType={filter.type} entityId={id} />\n                {index < total - 1 ? <Separator /> : null}\n              </Fragment>\n            ))}\n          </ChipLabel>\n          {total > 1 ? <TotalDisplay>({total})</TotalDisplay> : null}\n        </BaseChip>\n        {query ? (\n          <PopoverStyled\n            open={open}\n            anchorEl={anchorEl}\n            onClose={handleClose}\n            anchorOrigin={{ vertical: \"bottom\", horizontal: \"left\" }}\n          >\n            <AdvancedDropdown\n              query={query}\n              filter={filter}\n              icon={icon}\n              onRemove={handleRemoveItem}\n              onChange={handleOperationChange}\n              individualChange={handleIndividuallyOperation}\n            />\n          </PopoverStyled>\n        ) : null}\n      </>\n    )\n  },\n)\n\nexport { ArrayFilterChip }\n"],"names":["ArrayFilterChip","iconMap","language","rp_topic","source","keyword","forwardRef","filter","onRemove","query","ref","anchorEl","setAnchorEl","useState","open","Boolean","useDisableIOSTouch","total","value","length","icon","metadata","subType","type","handleClick","event","currentTarget","handleClose","handleRemoveItem","id","tagManagerEvents","queryRefinement","action","component","queryId","queryType","savedStatus","saveStatus","actions","expression","updateFilter","Array","isArray","currentId","handleOperationChange","operation","items","map","entityType","updateItems","handleIndividuallyOperation","entityId","BaseChip","clickable","QueryIcon","onClick","selected","ChipLabel","index","Fragment","NameDisplay","filterType","Separator","TotalDisplay","PopoverStyled","onClose","anchorOrigin","vertical","horizontal","AdvancedDropdown","onChange","individualChange"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}