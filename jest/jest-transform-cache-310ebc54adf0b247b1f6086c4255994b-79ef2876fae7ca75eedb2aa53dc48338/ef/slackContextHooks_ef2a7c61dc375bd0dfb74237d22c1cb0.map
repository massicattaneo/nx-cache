{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/common/providers/src/Slack/slackContextHooks.tsx"],"sourcesContent":["import { ReactNode, useCallback } from \"react\"\nimport { AxiosError } from \"axios\"\nimport { UpdateNotificationMutation } from \"@rp/common/api-types\"\nimport { slackInviteToChannel, useSlackValidateAccess } from \"@rp/react/tanstack-api/notifications\"\nimport { useUpdateSavedQueryField } from \"@rp/react/tanstack-api/user-data-queries\"\nimport { Typography } from \"@rp/react/web/mui/core\"\nimport { useMutation } from \"@tanstack/react-query\"\nimport { useSnackbar } from \"../Snackbar\"\n\nconst useSlackInviteToChannel = () => {\n  return useMutation({\n    mutationFn: slackInviteToChannel,\n  })\n}\n\nexport const useUpdateSchedule = () => {\n  const { enqueueError, enqueueSuccess } = useSnackbar()\n  const { mutateAsync: patchQuery } = useUpdateSavedQueryField({ enqueueError })\n  const { mutateAsync: invite } = useSlackInviteToChannel()\n  const { data } = useSlackValidateAccess()\n  const mutateAsync = useCallback(\n    async ({\n      queryId,\n      queryName,\n      schedules,\n      channelId,\n      destination,\n      deleteAll,\n    }: UpdateNotificationMutation) => {\n      const successMessage = ((): ReactNode => {\n        if (deleteAll) {\n          return (\n            <Typography>\n              You will no longer receive notifications from{\" \"}\n              <Typography fontWeight={700} component=\"span\">\n                {queryName}\n              </Typography>\n            </Typography>\n          )\n        }\n        return (\n          <Typography>\n            Your notifications for{\" \"}\n            <Typography fontWeight={700} component=\"span\">\n              {queryName}\n            </Typography>{\" \"}\n            have been updated\n          </Typography>\n        )\n      })()\n      const errorMessage = ((): ReactNode => {\n        if (deleteAll) {\n          return (\n            <Typography>\n              There was an error turning off all the notifications for{\" \"}\n              <Typography fontWeight={700} component=\"span\">\n                {queryName}\n              </Typography>\n            </Typography>\n          )\n        }\n        return (\n          <Typography>\n            There was an error updating your{\" \"}\n            <Typography fontWeight={700} component=\"span\">\n              {queryName}\n            </Typography>{\" \"}\n            notifications\n          </Typography>\n        )\n      })()\n\n      try {\n        if (destination === \"slack\") {\n          await new Promise<void>((res, rej) => {\n            if (channelId && data?.access && data?.slackUserId !== channelId) {\n              return invite({ channelId })\n                .then(() => res())\n                .catch(rej)\n            }\n            return res()\n          })\n        }\n        await patchQuery({\n          id: queryId,\n          fields: { schedules },\n        }).then(() => {\n          enqueueSuccess(successMessage)\n        })\n      } catch (e: unknown) {\n        if (e instanceof AxiosError && e.response?.status === 403) return\n        enqueueError(errorMessage)\n      }\n    },\n    [data, enqueueError, enqueueSuccess, invite, patchQuery],\n  )\n\n  return { mutateAsync }\n}\n"],"names":["useUpdateSchedule","useSlackInviteToChannel","useMutation","mutationFn","slackInviteToChannel","enqueueError","enqueueSuccess","useSnackbar","mutateAsync","patchQuery","useUpdateSavedQueryField","invite","data","useSlackValidateAccess","useCallback","queryId","queryName","schedules","channelId","destination","deleteAll","successMessage","Typography","fontWeight","component","errorMessage","Promise","res","rej","access","slackUserId","then","catch","id","fields","e","AxiosError","response","status"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAeaA;;;eAAAA;;;;uBAf0B;uBACZ;+BAEkC;iCACpB;sBACd;4BACC;0BACA;AAE5B,MAAMC,0BAA0B;IAC9B,OAAOC,IAAAA,uBAAW,EAAC;QACjBC,YAAYC,mCAAoB;IAClC;AACF;AAEO,MAAMJ,oBAAoB;IAC/B,MAAM,EAAEK,YAAY,EAAEC,cAAc,EAAE,GAAGC,IAAAA,qBAAW;IACpD,MAAM,EAAEC,aAAaC,UAAU,EAAE,GAAGC,IAAAA,yCAAwB,EAAC;QAAEL;IAAa;IAC5E,MAAM,EAAEG,aAAaG,MAAM,EAAE,GAAGV;IAChC,MAAM,EAAEW,IAAI,EAAE,GAAGC,IAAAA,qCAAsB;IACvC,MAAML,cAAcM,IAAAA,kBAAW,EAC7B,OAAO,EACLC,OAAO,EACPC,SAAS,EACTC,SAAS,EACTC,SAAS,EACTC,WAAW,EACXC,SAAS,EACkB;QAC3B,MAAMC,iBAAiB,AAAC,CAAA;YACtB,IAAID,WAAW;gBACb,qBACE,sBAACE,gBAAU;;wBAAC;wBACoC;sCAC9C,qBAACA,gBAAU;4BAACC,YAAY;4BAAKC,WAAU;sCACpCR;;;;YAIT;YACA,qBACE,sBAACM,gBAAU;;oBAAC;oBACa;kCACvB,qBAACA,gBAAU;wBAACC,YAAY;wBAAKC,WAAU;kCACpCR;;oBACW;oBAAI;;;QAIxB,CAAA;QACA,MAAMS,eAAe,AAAC,CAAA;YACpB,IAAIL,WAAW;gBACb,qBACE,sBAACE,gBAAU;;wBAAC;wBAC+C;sCACzD,qBAACA,gBAAU;4BAACC,YAAY;4BAAKC,WAAU;sCACpCR;;;;YAIT;YACA,qBACE,sBAACM,gBAAU;;oBAAC;oBACuB;kCACjC,qBAACA,gBAAU;wBAACC,YAAY;wBAAKC,WAAU;kCACpCR;;oBACW;oBAAI;;;QAIxB,CAAA;QAEA,IAAI;YACF,IAAIG,gBAAgB,SAAS;gBAC3B,MAAM,IAAIO,QAAc,CAACC,KAAKC;oBAC5B,IAAIV,cAAaN,iBAAAA,2BAAAA,KAAMiB,MAAM,KAAIjB,CAAAA,iBAAAA,2BAAAA,KAAMkB,WAAW,MAAKZ,WAAW;wBAChE,OAAOP,OAAO;4BAAEO;wBAAU,GACvBa,IAAI,CAAC,IAAMJ,OACXK,KAAK,CAACJ;oBACX;oBACA,OAAOD;gBACT;YACF;YACA,MAAMlB,WAAW;gBACfwB,IAAIlB;gBACJmB,QAAQ;oBAAEjB;gBAAU;YACtB,GAAGc,IAAI,CAAC;gBACNzB,eAAee;YACjB;QACF,EAAE,OAAOc,GAAY;gBACYA;YAA/B,IAAIA,aAAaC,iBAAU,IAAID,EAAAA,cAAAA,EAAEE,QAAQ,cAAVF,kCAAAA,YAAYG,MAAM,MAAK,KAAK;YAC3DjC,aAAaoB;QACf;IACF,GACA;QAACb;QAAMP;QAAcC;QAAgBK;QAAQF;KAAW;IAG1D,OAAO;QAAED;IAAY;AACvB"}