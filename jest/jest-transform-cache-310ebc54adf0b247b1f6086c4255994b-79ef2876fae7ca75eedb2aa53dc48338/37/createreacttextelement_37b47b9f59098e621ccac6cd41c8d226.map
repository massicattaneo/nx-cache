{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/rpjson/src/lib/create-react-elements/create-react-text-element.ts"],"sourcesContent":["import { createElement } from \"react\"\nimport { EnhancedTextBlock } from \"@rp/react/rpjson/types\"\nimport { CLASS_NAMES, TEXT_ROOT_PREFIX } from \"../constants\"\nimport { collectBreakPoints } from \"./collect-breakpoints\"\nimport { createEvent } from \"./create-event\"\nimport { getClassNameInfo, getHighlight } from \"./create-highlight-container\"\nimport {\n  Breakpoint,\n  Highlight,\n  ReactDocumentOptions,\n  ReactDocumentProps,\n  RpJsonBlockDetections,\n  RpJsonEvent,\n} from \"./create-react-elements.types\"\n\nconst createParagraphNumber = (block: EnhancedTextBlock) => {\n  return createElement(\"span\", {\n    key: `${block.id}_paragraph_number`,\n    children: `${block.paragraphNumber}. `,\n    className: CLASS_NAMES.PARAGRAPH_NUMBER,\n  })\n}\n\nconst createSentenceNumber = ({ id, count }: Breakpoint) => {\n  return createElement(\"span\", {\n    key: `${id}_${count}_sentence_number`,\n    children: `[${count}] `,\n    className: CLASS_NAMES.SENTENCE_NUMBER,\n  })\n}\n\nconst getClassNameKey = (key: string) =>\n  key\n    .split(\",\")\n    .filter(item => item)\n    .map(subItem => `${CLASS_NAMES.ID_PREFIX}${subItem}`)\n    .join(\" \")\n\nconst getClassName = (tag: Breakpoint) => {\n  if (!tag?.rpJsonId) return \"\"\n  return `${CLASS_NAMES.TYPE_PREFIX}${tag.rpJsonType} ${getClassNameKey(tag.rpJsonId)} ${\n    CLASS_NAMES.REACT_ID_PREFIX\n  }${tag.id}`\n}\n\nconst getHighlighsChildren = (\n  target: HTMLElement,\n  block: EnhancedTextBlock,\n  path: Array<EventTarget>,\n): Array<Highlight> => {\n  const accumulator: Array<Highlight> = []\n  return Array.from(target.children)\n    .map(element => element as HTMLElement)\n    .reduce((acc, el) => {\n      const { rpJsonId } = getClassNameInfo(el)\n      if (!rpJsonId) return acc\n      if (!path.includes(el)) return acc\n      const hl: Highlight = getHighlight(el, block)\n      return acc.concat(hl).concat(getHighlighsChildren(el, block, path))\n    }, accumulator)\n}\n\nconst getHighlightsParent = (\n  target: HTMLElement | null,\n  block: EnhancedTextBlock,\n): Array<Highlight> => {\n  if (!target) return []\n  if (!target.parentNode) return []\n  const { rpJsonId } = getClassNameInfo(target.parentElement)\n  if (!rpJsonId) return []\n  if (!target.parentElement) return []\n  const hl = getHighlight(target.parentElement, block)\n  const ret: Array<Highlight> = [hl]\n  return ret.concat(getHighlightsParent(target.parentElement, block))\n}\n\nconst removeDuplicates = (highlight: Highlight, index: number, array: Array<Highlight>) => {\n  const found = array.find(\n    (sub: Highlight) =>\n      sub.rpJsonId === highlight.rpJsonId && sub.rpJsonType === highlight.rpJsonType,\n  )\n  if (!found) return false\n  const foundIndex = array.indexOf(found)\n  return foundIndex === index\n}\n\nconst onAction = (\n  event: React.MouseEvent,\n  block: EnhancedTextBlock,\n  callback?: (originalEvent: React.MouseEvent, rpJsonEvent: RpJsonEvent) => void,\n) => {\n  if (!callback) return\n  const collection: Array<Highlight> = []\n  const highlight = getHighlight(event.target as HTMLElement, block)\n  if (!highlight.rpJsonId) return callback(event, createEvent())\n  collection.push(highlight)\n  const path = event.nativeEvent.composedPath()\n  const arr = getHighlighsChildren(event.target as HTMLElement, block, path).concat(\n    getHighlightsParent(event.target as HTMLElement, block),\n  )\n  collection.push(...arr)\n  const highlights = collection.filter(removeDuplicates)\n  callback(event, createEvent({ highlights }))\n}\n\nconst createSpanElement = (key: string, props: ReactDocumentProps, block: EnhancedTextBlock) => {\n  return createElement(\"span\", {\n    key,\n    children: [],\n    ...props,\n    onClick: (event: React.MouseEvent) => onAction(event, block, props.onClick),\n    onMouseEnter: (event: React.MouseEvent) => onAction(event, block, props.onMouseEnter),\n    onMouseLeave: (event: React.MouseEvent) => onAction(event, block, props.onMouseLeave),\n  })\n}\n\nconst pushToProps =\n  (index: number, props: ReactDocumentProps, block: EnhancedTextBlock) =>\n  (parent: React.ReactElement<ReactDocumentProps>, item: Breakpoint) => {\n    const propHere = { ...props, className: getClassName(item) }\n    const newItem = createSpanElement(`${item.id}-${index}`, propHere, block)\n    if (Array.isArray(parent.props.children)) {\n      parent.props.children.push(newItem)\n    }\n    return newItem\n  }\n\nconst getParagraphClassname = ({ paragraphNumber }: EnhancedTextBlock) => {\n  return `${CLASS_NAMES.PARAGRAPH_NUMBER_PREFIX}${paragraphNumber}`\n}\n\nexport const createReactTextElement = (\n  block: EnhancedTextBlock,\n  props: ReactDocumentProps,\n  rpJsonDetections: RpJsonBlockDetections,\n  options: ReactDocumentOptions = {},\n) => {\n  const { idIterator = () => \"\" } = options\n  const className = `${TEXT_ROOT_PREFIX}${block.id} ${getParagraphClassname(block)}`\n  const wrapper = createSpanElement(`${block.id}_text`, { ...props, className }, block)\n\n  if (!wrapper.props.children) {\n    wrapper.props.children = []\n  }\n  if (Array.isArray(wrapper.props.children))\n    wrapper.props.children.push(createParagraphNumber(block))\n\n  const breakpoints = collectBreakPoints(block, rpJsonDetections, options)\n\n  const tags: Array<Breakpoint> = []\n  breakpoints.reduce((parent, item, index) => {\n    const previous = breakpoints[index - 1] || { index: 0 }\n    const piece = block.text.substring(previous.index, item.index)\n    if (!parent.props.children) {\n      // eslint-disable-next-line no-param-reassign\n      parent.props.children = []\n    }\n    if (!Array.isArray(parent.props.children)) return parent\n    if (parent === wrapper && piece) {\n      parent.props.children.push(\n        createElement(\"span\", {\n          key: idIterator(),\n          children: piece,\n          className: \"rpjson-type-no-sentence\",\n        }),\n      )\n    } else if (piece) {\n      parent.props.children.push(piece)\n    }\n    if (item.isBreakLine) {\n      if (item.isStart) parent.props.children.push(createElement(\"br\", { key: item.id }))\n      return parent\n    } else if (item.isSentenceNumber) {\n      parent.props.children.push(createSentenceNumber(item))\n      return parent\n    } else if (item.isStart) {\n      tags.push(item)\n      return pushToProps(index, props, block)(parent, item)\n    } else if (item.isEnd) {\n      const find = tags.find(i => i.id === item.id)\n      tags.splice(find ? tags.indexOf(find) : -1, 1)\n      const ret = tags.reduce(pushToProps(index, props, block), wrapper)\n      return ret\n    } else {\n      return parent\n    }\n  }, wrapper)\n\n  return wrapper\n}\n"],"names":["createReactTextElement","createParagraphNumber","block","createElement","key","id","children","paragraphNumber","className","CLASS_NAMES","PARAGRAPH_NUMBER","createSentenceNumber","count","SENTENCE_NUMBER","getClassNameKey","split","filter","item","map","subItem","ID_PREFIX","join","getClassName","tag","rpJsonId","TYPE_PREFIX","rpJsonType","REACT_ID_PREFIX","getHighlighsChildren","target","path","accumulator","Array","from","element","reduce","acc","el","getClassNameInfo","includes","hl","getHighlight","concat","getHighlightsParent","parentNode","parentElement","ret","removeDuplicates","highlight","index","array","found","find","sub","foundIndex","indexOf","onAction","event","callback","collection","createEvent","push","nativeEvent","composedPath","arr","highlights","createSpanElement","props","onClick","onMouseEnter","onMouseLeave","pushToProps","parent","propHere","newItem","isArray","getParagraphClassname","PARAGRAPH_NUMBER_PREFIX","rpJsonDetections","options","idIterator","TEXT_ROOT_PREFIX","wrapper","breakpoints","collectBreakPoints","tags","previous","piece","text","substring","isBreakLine","isStart","isSentenceNumber","isEnd","i","splice"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}