{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/development/src/lib/trpc/bigdata-api/procedures/user-data/custom-data-views-procedures.ts"],"sourcesContent":["import { z } from \"zod\"\nimport { bigdataSchemas } from \"@rp/common/contracts\"\nimport { TRPCError } from \"@trpc/server\"\nimport { generateId, userOwner } from \"../../../../database\"\nimport { bigdataApiProcedure } from \"../../bigdata-api-procedure\"\n\nexport const userDataCustomDataViewsProcedures = {\n  list: bigdataApiProcedure\n    .meta({ openapi: { method: \"GET\", path: \"/custom-data-views\" } })\n    .input(z.object({}))\n    .output(bigdataSchemas.st_bff_data_tools_CustomDataViewListResponse)\n    .query(async ({ ctx }) => {\n      const results = await ctx.db.collection(\"customDataViews\").find()\n      return { results }\n    }),\n\n  create: bigdataApiProcedure\n    .meta({ openapi: { method: \"POST\", path: \"/custom-data-views\" } })\n    .input(bigdataSchemas.st_bff_data_tools_CreateCustomDataViewRequest)\n    .output(bigdataSchemas.st_bff_data_tools_CustomDataViewResponse)\n    .mutation(async ({ ctx, input }) => {\n      const now = new Date().toISOString()\n      const newView = {\n        id: generateId(),\n        columns: input.columns,\n        createdAt: now,\n        updatedAt: now,\n        user_id: userOwner.ownerUserId,\n      }\n      return ctx.db.collection(\"customDataViews\").insertOne(newView)\n    }),\n\n  update: bigdataApiProcedure\n    .meta({ openapi: { method: \"PATCH\", path: \"/custom-data-views/:id\" } })\n    .input(\n      z\n        .object({ id: z.string() })\n        .merge(bigdataSchemas.st_bff_data_tools_UpdateCustomDataViewRequest),\n    )\n    .output(bigdataSchemas.st_bff_data_tools_CustomDataViewResponse)\n    .mutation(async ({ ctx, input }) => {\n      const { id, ...updateData } = input\n\n      const existing = await ctx.db.collection(\"customDataViews\").findOne({ id })\n      if (!existing) {\n        throw new TRPCError({ code: \"NOT_FOUND\", message: \"Custom data view not found\" })\n      }\n\n      const updatedView = {\n        ...existing,\n        columns: updateData.columns !== null ? updateData.columns : existing.columns,\n        updatedAt: new Date().toISOString(),\n      }\n\n      const result = await ctx.db.collection(\"customDataViews\").updateOne({ id }, updatedView)\n      if (!result) {\n        throw new TRPCError({ code: \"NOT_FOUND\", message: \"Custom data view not found\" })\n      }\n\n      return result\n    }),\n\n  delete: bigdataApiProcedure\n    .meta({ openapi: { method: \"DELETE\", path: \"/custom-data-views/:id\" } })\n    .input(z.object({ id: z.string() }))\n    .output(z.object({ id: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      const existing = await ctx.db.collection(\"customDataViews\").findOne({ id: input.id })\n      if (!existing) {\n        throw new TRPCError({ code: \"NOT_FOUND\", message: \"Custom data view not found\" })\n      }\n\n      await ctx.db.collection(\"customDataViews\").deleteOne({ id: input.id })\n      return { id: input.id }\n    }),\n}\n"],"names":["userDataCustomDataViewsProcedures","list","bigdataApiProcedure","meta","openapi","method","path","input","z","object","output","bigdataSchemas","st_bff_data_tools_CustomDataViewListResponse","query","ctx","results","db","collection","find","create","st_bff_data_tools_CreateCustomDataViewRequest","st_bff_data_tools_CustomDataViewResponse","mutation","now","Date","toISOString","newView","id","generateId","columns","createdAt","updatedAt","user_id","userOwner","ownerUserId","insertOne","update","string","merge","st_bff_data_tools_UpdateCustomDataViewRequest","updateData","existing","findOne","TRPCError","code","message","updatedView","result","updateOne","delete","deleteOne"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}