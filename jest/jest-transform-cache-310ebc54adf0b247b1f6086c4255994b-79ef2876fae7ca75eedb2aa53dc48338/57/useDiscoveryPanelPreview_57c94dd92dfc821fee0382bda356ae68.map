{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/common/discovery-sidebar/src/hooks/useDiscoveryPanelPreview.ts"],"sourcesContent":["import { useEffect } from \"react\"\nimport {\n  CqsCategories,\n  CqsSearchQuery,\n  PostDiscoveryPanelResponse,\n  getDiscoveryPanelCategories,\n} from \"@rp/common/api-types\"\nimport { axiosClient } from \"@rp/react/axios-client\"\nimport { useCqsByIdsContext } from \"@rp/react/tanstack-api/cqs-by-ids\"\nimport { useQueryContext, useResultsPageState } from \"@rp/react/web/common/providers\"\nimport { discoveryPanelKey, useDiscoveryPanelKey } from \"@rp/react/web/cqs-query-context\"\nimport { isCqsQueryNotEmpty } from \"@rp/react/web/cqs-utils\"\nimport { QueryFunctionContext, useQuery } from \"@tanstack/react-query\"\nimport { modifyDiscoveryPanelData } from \"./useDiscoveryPanelPreview.helpers\"\n\ntype FetchProps = QueryFunctionContext<ReturnType<typeof discoveryPanelKey>>\n\nconst fetchSearchPreview = async ({ queryKey }: FetchProps): Promise<CqsCategories> => {\n  const [, , search] = queryKey\n\n  const query: CqsSearchQuery = {\n    ...search,\n    hybrid: true,\n  }\n\n  const { data } = await axiosClient.post<PostDiscoveryPanelResponse>(\"/cqs/discovery-panel\", query)\n  return getDiscoveryPanelCategories(data)\n}\n\nconst useDiscoveryPanelPreview = (search: CqsSearchQuery | undefined, enabled = true) => {\n  const { addByIds } = useCqsByIdsContext()\n  const getDiscoveryPanelKey = useDiscoveryPanelKey()\n\n  const results = useQuery({\n    queryKey: getDiscoveryPanelKey(search),\n    queryFn: fetchSearchPreview,\n    staleTime: 5000,\n    gcTime: 5000,\n    refetchOnWindowFocus: false,\n    enabled: enabled && search !== undefined,\n    select: data => modifyDiscoveryPanelData(data),\n  })\n\n  useEffect(() => {\n    if (results.isSuccess && results.data) {\n      addByIds(Object.values(results.data).flat())\n    }\n  }, [addByIds, results.data, results.isSuccess])\n\n  return results\n}\n\nconst useCurrentDiscoveryPanelPreview = () => {\n  const [resultsPageState] = useResultsPageState()\n  const {\n    savedQuery: { query },\n    searchQuery,\n    uiState,\n  } = useQueryContext()\n\n  const hasQuery =\n    query !== undefined && isCqsQueryNotEmpty(searchQuery) && isCqsQueryNotEmpty(query)\n  const enabled = hasQuery && !(resultsPageState === \"loading\" || resultsPageState === \"empty\")\n\n  return {\n    ...useDiscoveryPanelPreview(searchQuery, enabled),\n    isFetchingInitialResults:\n      (uiState.isSummaryLoading && enabled) || (hasQuery && resultsPageState === \"loading\"),\n    hasQuery,\n    resultsPageState,\n  }\n}\n\nexport { useCurrentDiscoveryPanelPreview }\n"],"names":["useCurrentDiscoveryPanelPreview","fetchSearchPreview","queryKey","search","query","hybrid","data","axiosClient","post","getDiscoveryPanelCategories","useDiscoveryPanelPreview","enabled","addByIds","useCqsByIdsContext","getDiscoveryPanelKey","useDiscoveryPanelKey","results","useQuery","queryFn","staleTime","gcTime","refetchOnWindowFocus","undefined","select","modifyDiscoveryPanelData","useEffect","isSuccess","Object","values","flat","resultsPageState","useResultsPageState","savedQuery","searchQuery","uiState","useQueryContext","hasQuery","isCqsQueryNotEmpty","isFetchingInitialResults","isSummaryLoading"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAyESA;;;eAAAA;;;uBAzEiB;0BAMnB;6BACqB;0BACO;2BACkB;iCACG;0BACrB;4BACY;iDACN;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIzC,MAAMC,qBAAqB,OAAO,EAAEC,QAAQ,EAAc;IACxD,MAAM,KAAKC,OAAO,GAAGD;IAErB,MAAME,QAAwB,wCACzBD;QACHE,QAAQ;;IAGV,MAAM,EAAEC,IAAI,EAAE,GAAG,MAAMC,wBAAW,CAACC,IAAI,CAA6B,wBAAwBJ;IAC5F,OAAOK,IAAAA,qCAA2B,EAACH;AACrC;AAEA,MAAMI,2BAA2B,CAACP,QAAoCQ,UAAU,IAAI;IAClF,MAAM,EAAEC,QAAQ,EAAE,GAAGC,IAAAA,4BAAkB;IACvC,MAAMC,uBAAuBC,IAAAA,qCAAoB;IAEjD,MAAMC,UAAUC,IAAAA,oBAAQ,EAAC;QACvBf,UAAUY,qBAAqBX;QAC/Be,SAASjB;QACTkB,WAAW;QACXC,QAAQ;QACRC,sBAAsB;QACtBV,SAASA,WAAWR,WAAWmB;QAC/BC,QAAQjB,CAAAA,OAAQkB,IAAAA,yDAAwB,EAAClB;IAC3C;IAEAmB,IAAAA,gBAAS,EAAC;QACR,IAAIT,QAAQU,SAAS,IAAIV,QAAQV,IAAI,EAAE;YACrCM,SAASe,OAAOC,MAAM,CAACZ,QAAQV,IAAI,EAAEuB,IAAI;QAC3C;IACF,GAAG;QAACjB;QAAUI,QAAQV,IAAI;QAAEU,QAAQU,SAAS;KAAC;IAE9C,OAAOV;AACT;AAEA,MAAMhB,kCAAkC;IACtC,MAAM,CAAC8B,iBAAiB,GAAGC,IAAAA,8BAAmB;IAC9C,MAAM,EACJC,YAAY,EAAE5B,KAAK,EAAE,EACrB6B,WAAW,EACXC,OAAO,EACR,GAAGC,IAAAA,0BAAe;IAEnB,MAAMC,WACJhC,UAAUkB,aAAae,IAAAA,4BAAkB,EAACJ,gBAAgBI,IAAAA,4BAAkB,EAACjC;IAC/E,MAAMO,UAAUyB,YAAY,CAAEN,CAAAA,qBAAqB,aAAaA,qBAAqB,OAAM;IAE3F,OAAO,wCACFpB,yBAAyBuB,aAAatB;QACzC2B,0BACE,AAACJ,QAAQK,gBAAgB,IAAI5B,WAAayB,YAAYN,qBAAqB;QAC7EM;QACAN;;AAEJ"}