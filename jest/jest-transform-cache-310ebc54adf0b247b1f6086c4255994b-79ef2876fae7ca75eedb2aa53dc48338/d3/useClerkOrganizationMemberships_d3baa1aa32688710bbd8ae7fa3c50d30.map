{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/common/hooks/src/lib/useClerkOrganizationMemberships.ts"],"sourcesContent":["import { useEffect, useMemo, useRef } from \"react\"\nimport { OrganizationMembershipResource } from \"@clerk/types\"\nimport \"@rp/adapters\"\nimport { useQuery } from \"@tanstack/react-query\"\nimport { useQueryClient } from \"@tanstack/react-query\"\n\nconst MAX_ITERATIONS = 1_000\n\nconst getAllOrganizationMemberships = async () => {\n  const pageSize = 200\n  let hasFinished = false\n  let initialPage = 1\n  const collected: Array<OrganizationMembershipResource> = []\n\n  while (!hasFinished) {\n    if (initialPage > MAX_ITERATIONS) {\n      break\n    }\n\n    const response = await window.Clerk?.organization?.getMemberships({\n      pageSize,\n      initialPage,\n    })\n\n    initialPage++\n\n    if (!response) {\n      break\n    }\n\n    const { data, total_count } = response\n\n    if (data) {\n      collected.push(...data)\n    }\n\n    hasFinished = total_count === collected.length\n  }\n\n  return collected\n}\n\nconst useClerkOrganizationMemberships = () => {\n  return useQuery({\n    queryKey: [\"clerk-organization-memberships\"],\n    queryFn: getAllOrganizationMemberships,\n    staleTime: 60 * 60 * 1000,\n  })\n}\n\nconst useClerkOrganizationMember = (id: string | undefined) => {\n  const { data, isLoading, isFetching, isFetched, ...rest } = useClerkOrganizationMemberships()\n  const retries = useRef(0)\n  const queryClient = useQueryClient()\n\n  const user = useMemo(() => {\n    if (!data || !id) return\n    return data.find(u => u.publicUserData.userId === id)\n  }, [data, id])\n\n  useEffect(() => {\n    if (user) return\n    if (!data || !id) return\n    if (isLoading || isFetching || isFetched) return\n    if (retries.current > 3) return\n    retries.current++\n    queryClient.refetchQueries({ queryKey: [\"clerk-organization-memberships\"] })\n  }, [data, id, isFetched, isFetching, isLoading, queryClient, retries, user])\n\n  return { ...rest, isLoading, isFetching, data: user }\n}\n\nexport { useClerkOrganizationMemberships, useClerkOrganizationMember }\n"],"names":["useClerkOrganizationMember","useClerkOrganizationMemberships","MAX_ITERATIONS","getAllOrganizationMemberships","pageSize","hasFinished","initialPage","collected","window","response","Clerk","organization","getMemberships","data","total_count","push","length","useQuery","queryKey","queryFn","staleTime","id","isLoading","isFetching","isFetched","rest","retries","useRef","queryClient","useQueryClient","user","useMemo","find","u","publicUserData","userId","useEffect","current","refetchQueries"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;;;;;;;;IAwE0CA,0BAA0B;eAA1BA;;IAAjCC,+BAA+B;eAA/BA;;;uBAxEkC;QAEpC;4BACkB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGzB,MAAMC,iBAAiB;AAEvB,MAAMC,gCAAgC;IACpC,MAAMC,WAAW;IACjB,IAAIC,cAAc;IAClB,IAAIC,cAAc;IAClB,MAAMC,YAAmD,EAAE;IAE3D,MAAO,CAACF,YAAa;YAKIG,4BAAAA;QAJvB,IAAIF,cAAcJ,gBAAgB;YAChC;QACF;QAEA,MAAMO,WAAW,QAAMD,gBAAAA,OAAOE,KAAK,cAAZF,qCAAAA,6BAAAA,cAAcG,YAAY,cAA1BH,iDAAAA,2BAA4BI,cAAc,CAAC;YAChER;YACAE;QACF;QAEAA;QAEA,IAAI,CAACG,UAAU;YACb;QACF;QAEA,MAAM,EAAEI,IAAI,EAAEC,WAAW,EAAE,GAAGL;QAE9B,IAAII,MAAM;YACRN,UAAUQ,IAAI,IAAIF;QACpB;QAEAR,cAAcS,gBAAgBP,UAAUS,MAAM;IAChD;IAEA,OAAOT;AACT;AAEA,MAAMN,kCAAkC;IACtC,OAAOgB,IAAAA,oBAAQ,EAAC;QACdC,UAAU;YAAC;SAAiC;QAC5CC,SAAShB;QACTiB,WAAW,KAAK,KAAK;IACvB;AACF;AAEA,MAAMpB,6BAA6B,CAACqB;IAClC,MAA4DpB,mCAAAA,mCAAtD,EAAEY,IAAI,EAAES,SAAS,EAAEC,UAAU,EAAEC,SAAS,EAAW,GAAGvB,kCAATwB,kCAASxB;QAApDY;QAAMS;QAAWC;QAAYC;;IACrC,MAAME,UAAUC,IAAAA,aAAM,EAAC;IACvB,MAAMC,cAAcC,IAAAA,0BAAc;IAElC,MAAMC,OAAOC,IAAAA,cAAO,EAAC;QACnB,IAAI,CAAClB,QAAQ,CAACQ,IAAI;QAClB,OAAOR,KAAKmB,IAAI,CAACC,CAAAA,IAAKA,EAAEC,cAAc,CAACC,MAAM,KAAKd;IACpD,GAAG;QAACR;QAAMQ;KAAG;IAEbe,IAAAA,gBAAS,EAAC;QACR,IAAIN,MAAM;QACV,IAAI,CAACjB,QAAQ,CAACQ,IAAI;QAClB,IAAIC,aAAaC,cAAcC,WAAW;QAC1C,IAAIE,QAAQW,OAAO,GAAG,GAAG;QACzBX,QAAQW,OAAO;QACfT,YAAYU,cAAc,CAAC;YAAEpB,UAAU;gBAAC;aAAiC;QAAC;IAC5E,GAAG;QAACL;QAAMQ;QAAIG;QAAWD;QAAYD;QAAWM;QAAaF;QAASI;KAAK;IAE3E,OAAO,wCAAKL;QAAMH;QAAWC;QAAYV,MAAMiB;;AACjD"}