{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/document-viewer/src/lib/DocumentViewerPage/pdf/PDFViewer.tsx"],"sourcesContent":["import { useCallback, useEffect, useState } from \"react\"\nimport type { PDFDocumentProxy } from \"pdfjs-dist\"\nimport { Document, pdfjs } from \"react-pdf\"\nimport \"react-pdf/dist/Page/AnnotationLayer.css\"\nimport \"react-pdf/dist/esm/Page/AnnotationLayer.css\"\nimport \"react-pdf/dist/esm/Page/TextLayer.css\"\nimport { useFileUrl } from \"@rp/react/tanstack-api/file\"\nimport { LoadingSpinner } from \"@rp/react/web/common/base-components\"\nimport { MaxWidthContainer } from \"@rp/react/web/common/composite-components\"\nimport { InfiniteList } from \"@rp/react/web/common/composite-components\"\nimport { HtmlPageHead } from \"@rp/react/web/common/header-components\"\nimport { useDeviceInfo, useResizeObserver } from \"@rp/react/web/common/hooks\"\nimport { Box } from \"@rp/react/web/mui/core\"\nimport { CustomDocumentHeaderProps } from \"../../DocumentViewer.types\"\nimport { PageWithObserver } from \"../PageWithObserver\"\nimport { usePageBoundingBox } from \"../hooks/usePageBoundingBox\"\nimport { PDFViewerHeader } from \"./PDFViewerHeader\"\n\npdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.js`\n\n// Config\nconst options = {\n  cMapUrl: \"/cmaps/\",\n  standardFontDataUrl: \"/standard_fonts/\",\n}\n\nconst resizeObserverOptions = {}\n\nconst maxWidth = 800\n\n// Types\ntype Props = {\n  documentId: string\n  backTitle: string\n  handleClick: () => void\n  name: string\n  disableBackButton: boolean\n  isPrivate: boolean\n  pdfUrl?: string\n  pdfHeaderOffset?: number\n  pdfBodyOffset?: number\n  isFromChat: boolean\n  customDocumentHeaderProps?: CustomDocumentHeaderProps\n}\n\nfunction PDFViewer({\n  documentId,\n  backTitle,\n  handleClick,\n  name,\n  disableBackButton,\n  isPrivate,\n  pdfUrl,\n  pdfHeaderOffset = 0,\n  pdfBodyOffset = 0,\n  customDocumentHeaderProps,\n}: Props) {\n  const [numPages, setNumPages] = useState<number>(0)\n  const [visiblePages, setVisiblePages] = useState({})\n  const [scale, setScale] = useState(1)\n  const [renderedScale, setRenderedScale] = useState(1)\n\n  const [containerRef, setContainerRef] = useState<HTMLElement | null>(null)\n  const [containerWidth, setContainerWidth] = useState<number>()\n\n  const { data: { url: fileUrl } = { url: \"\" } } = useFileUrl(isPrivate ? documentId : \"\")\n  const { isMobile } = useDeviceInfo()\n\n  const { boundingBox } = usePageBoundingBox()\n\n  const url = fileUrl || pdfUrl\n\n  // Handlers\n  const onDocumentLoadSuccess = ({ numPages: nextNumPages }: PDFDocumentProxy): void =>\n    setNumPages(nextNumPages)\n\n  // Resize observer\n  const onResize = useCallback<ResizeObserverCallback>(entries => {\n    const [entry] = entries\n\n    if (entry) {\n      setContainerWidth(entry.contentRect.width)\n    }\n  }, [])\n  useResizeObserver(containerRef, resizeObserverOptions, onResize)\n\n  // Page number handling\n  const setPageVisibility = useCallback((pageNumber: number, isIntersecting: boolean) => {\n    setVisiblePages(prevVisiblePages => ({\n      ...prevVisiblePages,\n      [pageNumber]: isIntersecting,\n    }))\n  }, [])\n\n  // Current page\n  const [currentPage, setCurrentPage] = useState(boundingBox.page || 1)\n\n  useEffect(() => {\n    const firstVisiblePage =\n      Object.entries(visiblePages)\n        .filter(([_key, value]) => value)\n        .map(([key]) => key)[0] ?? \"\"\n    if (firstVisiblePage && parseInt(firstVisiblePage) !== currentPage) {\n      setCurrentPage(parseInt(firstVisiblePage))\n    }\n  }, [currentPage, visiblePages])\n\n  const isScaleUpdating = renderedScale !== scale\n  const pages = new Array(numPages).fill(0).map((_, index) => ({ id: index.toString(), index }))\n  const isDocumentLoaded = !!numPages\n\n  const isPaneView = customDocumentHeaderProps?.variant === \"pane\"\n\n  return (\n    <Box\n      sx={{\n        width: \"100%\",\n        paddingTop: `${pdfBodyOffset}px`,\n        position: \"relative\",\n      }}\n    >\n      <HtmlPageHead title={name} />\n\n      <LoadingSpinner loading={!isDocumentLoaded} />\n\n      {isDocumentLoaded && (\n        <PDFViewerHeader\n          isMobile={isMobile}\n          backTitle={backTitle}\n          handleClick={handleClick}\n          name={name}\n          numPages={numPages}\n          currentPage={currentPage}\n          scale={scale}\n          setScale={setScale}\n          documentId={documentId}\n          disableBackButton={disableBackButton}\n          isPrivate={isPrivate}\n          pdfHeaderOffset={pdfHeaderOffset}\n          customDocumentHeaderProps={customDocumentHeaderProps}\n        />\n      )}\n\n      <MaxWidthContainer>\n        <Box\n          ref={setContainerRef}\n          sx={{\n            display: \"flex\",\n            overflowX: \"auto\",\n            \"& .react-pdf__Document\": {\n              marginInline: \"auto\",\n            },\n\n            \"& .react-pdf__Page\": {\n              backgroundColor: \"transparent !important\",\n              marginTop: \"30px\",\n              marginBottom: \"30px\",\n            },\n            \"& .react-pdf__Page.scaleUpdating\": {\n              display: \"none\",\n            },\n          }}\n        >\n          {url && (\n            <Document\n              file={url}\n              onLoadSuccess={onDocumentLoadSuccess}\n              options={options}\n              loading={<LoadingSpinner />}\n            >\n              <InfiniteList\n                initialElements={boundingBox.page || 1}\n                virtualized\n                items={pages}\n                renderItem={({ index }) => {\n                  return (\n                    <>\n                      {isScaleUpdating && renderedScale && (\n                        <PageWithObserver\n                          initPage={boundingBox.page}\n                          data-testid={`page_${index + 1}`}\n                          key={`page_${index + 1}@${renderedScale}`}\n                          pageNumber={index + 1}\n                          scale={renderedScale}\n                          setPageVisibility={setPageVisibility}\n                          width={containerWidth ? Math.min(containerWidth, maxWidth) : maxWidth}\n                          boundingBox={boundingBox}\n                          isPaneView={isPaneView}\n                        />\n                      )}\n                      <PageWithObserver\n                        initPage={boundingBox.page}\n                        className={`${isScaleUpdating ? \"scaleUpdating\" : \"\"}`}\n                        data-testid={`page_${index + 1}`}\n                        key={`page_${index + 1}@${scale}`}\n                        onRenderSuccess={() => setRenderedScale(scale)}\n                        pageNumber={index + 1}\n                        scale={scale}\n                        setPageVisibility={setPageVisibility}\n                        width={containerWidth ? Math.min(containerWidth, maxWidth) : maxWidth}\n                        boundingBox={boundingBox}\n                        isPaneView={isPaneView}\n                      />\n                    </>\n                  )\n                }}\n              />\n            </Document>\n          )}\n        </Box>\n      </MaxWidthContainer>\n    </Box>\n  )\n}\n\nexport default PDFViewer\n"],"names":["pdfjs","GlobalWorkerOptions","workerSrc","version","options","cMapUrl","standardFontDataUrl","resizeObserverOptions","maxWidth","PDFViewer","documentId","backTitle","handleClick","name","disableBackButton","isPrivate","pdfUrl","pdfHeaderOffset","pdfBodyOffset","customDocumentHeaderProps","numPages","setNumPages","useState","visiblePages","setVisiblePages","scale","setScale","renderedScale","setRenderedScale","containerRef","setContainerRef","containerWidth","setContainerWidth","data","url","fileUrl","useFileUrl","isMobile","useDeviceInfo","boundingBox","usePageBoundingBox","onDocumentLoadSuccess","nextNumPages","onResize","useCallback","entries","entry","contentRect","width","useResizeObserver","setPageVisibility","pageNumber","isIntersecting","prevVisiblePages","currentPage","setCurrentPage","page","useEffect","Object","firstVisiblePage","filter","_key","value","map","key","parseInt","isScaleUpdating","pages","Array","fill","_","index","id","toString","isDocumentLoaded","isPaneView","variant","Box","sx","paddingTop","position","HtmlPageHead","title","LoadingSpinner","loading","PDFViewerHeader","MaxWidthContainer","ref","display","overflowX","marginInline","backgroundColor","marginTop","marginBottom","Document","file","onLoadSuccess","InfiniteList","initialElements","virtualized","items","renderItem","PageWithObserver","initPage","data-testid","Math","min","className","onRenderSuccess"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}