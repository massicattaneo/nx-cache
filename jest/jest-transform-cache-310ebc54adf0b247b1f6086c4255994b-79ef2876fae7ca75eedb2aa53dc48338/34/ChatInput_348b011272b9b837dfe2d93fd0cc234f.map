{"version":3,"sources":["/Users/mcattaneo/workspace/frontend/libs/react/web/chat/src/lib/Chat/ChatInput/ChatInput.tsx"],"sourcesContent":["import React, {\n  ChangeEvent,\n  Dispatch,\n  SetStateAction,\n  forwardRef,\n  useCallback,\n  useRef,\n  useState,\n} from \"react\"\nimport noop from \"lodash/noop\"\nimport { DatasetScope } from \"@rp/common/api-types\"\nimport { useAccount } from \"@rp/react/common/providers\"\nimport { useSelectSourceAction } from \"@rp/react/common/source-selector\"\nimport { UploadInputRef } from \"@rp/react/web/common/base-components\"\nimport { useFileActions } from \"@rp/react/web/common/files\"\nimport { useDeviceInfo, useDeviceSize } from \"@rp/react/web/common/hooks\"\nimport { useModal } from \"@rp/react/web/common/providers\"\nimport { Box } from \"@rp/react/web/mui/core\"\nimport {\n  AddSourceButton,\n  AddWatchlistButton,\n  AttachFileButton,\n  GeneratingIcon,\n  SubmitPromptButton,\n} from \"./ChatControls\"\nimport { ChatInputContainer, TextArea } from \"./ChatInput.styles\"\nimport { ChatInputFilters } from \"./ChatInputFilters/ChatInputFilters\"\n\nconst SCOPE_DISPLAY_CLASS_NAME = \"scope-display\"\nconst CHAT_INPUT_WRAPPER_CLASS_NAME = \"chat-input-wrapper\"\nconst CHAT_INPUT_CONTAINER_CLASS_NAME = \"chat-input-container\"\nconst CHAT_INPUT_CONTROLS_CLASS_NAME = \"chat-input-controls\"\n\ntype Props = {\n  id?: string\n  prompt: string\n  setPrompt: (prompt: string) => void\n  submitPrompt: () => void\n  variant?: \"new\" | \"add\"\n  placeholder: string\n  generating?: boolean\n  stopGenerating?: () => void\n  scope?: DatasetScope\n  setScope?: (scope: DatasetScope | undefined) => void\n  setWatchlistId?: Dispatch<SetStateAction<string | undefined>>\n  isDatasetsOpen?: boolean\n  openDatasetPopper?: () => void\n  closeDatasetPopper?: () => void\n  handleKeyDown?: (event: React.KeyboardEvent<HTMLTextAreaElement>) => void\n  isValidPrompt?: boolean\n  multiline?: boolean\n  hidden?: boolean\n  filesIds?: Array<string>\n  setFilesIds?: Dispatch<SetStateAction<Array<string>>>\n  submitFileRef?: React.RefObject<UploadInputRef | null>\n  inputRef?: React.RefObject<HTMLTextAreaElement | null>\n  handleOpenWatchlistModal?: () => void\n  watchlistId?: string | undefined\n  isFreeTierEnabled?: boolean\n  hideControls?: Array<\"source\" | \"watchlist\" | \"files\">\n  isHomePageChat?: boolean\n  onFocus?: () => void\n}\n\nconst ChatInput = forwardRef<HTMLDivElement, Props>(\n  (\n    {\n      id,\n      prompt,\n      setPrompt,\n      submitPrompt,\n      variant = \"new\",\n      generating = false,\n      stopGenerating,\n      scope,\n      setScope = () => {},\n      isDatasetsOpen = false,\n      openDatasetPopper = () => {},\n      closeDatasetPopper = () => {},\n      handleKeyDown = () => {},\n      isValidPrompt = false,\n      multiline,\n      hidden = false,\n      filesIds = [],\n      setFilesIds = () => {},\n      submitFileRef,\n      inputRef,\n      handleOpenWatchlistModal = () => {},\n      watchlistId,\n      setWatchlistId = () => {},\n      isFreeTierEnabled = false,\n      hideControls = [],\n      placeholder,\n      isHomePageChat = false,\n      onFocus,\n    },\n    ref,\n  ) => {\n    const { actions } = useFileActions()\n    const searchingForDatasets = useRef(false)\n    const { isMobile, isSafari } = useDeviceInfo()\n    const { isDeviceKeyboardOpen } = useDeviceSize()\n    const { hasEntitlement } = useAccount()\n\n    const rows = isMobile ? 5 : 8\n    const hiddenPlaceholder = hidden ? \"\" : placeholder\n\n    const areFilesAdded = filesIds.length > 0\n    const areWatchlistAdded = watchlistId !== undefined\n    const areDatasetsAdded = scope !== undefined\n\n    const areActiveFilters = areFilesAdded || areWatchlistAdded || areDatasetsAdded\n    const [inputHasFocus, setInputHasFocus] = useState(false)\n\n    const removeFiles = useCallback(\n      (ids: Array<string>) => {\n        setFilesIds(prev => prev.filter(id => !ids.includes(id)))\n      },\n      [setFilesIds],\n    )\n\n    const { selectFilesModal } = useModal()\n    const openFileModal = () =>\n      selectFilesModal.handleOpen({\n        isFreeTierEnabled,\n        filesIds,\n        selected: filesIds,\n        onUploadClick: () => {\n          if (!submitFileRef?.current) return Promise.resolve([])\n          return submitFileRef.current.open()\n        },\n        onDeleteFile: fileId => {\n          setFilesIds(prev => prev.filter(id => id !== fileId))\n        },\n        onSuccess: ids => {\n          setFilesIds(ids)\n          // TODO: Focus input on close\n          // setTimeout(() => {\n          //   ref.current.focus()\n          // })\n        },\n      })\n\n    const onChange = (event: ChangeEvent<HTMLTextAreaElement>) => {\n      const value = event.target.value\n      if (value === \"@\") {\n        searchingForDatasets.current = true\n      }\n\n      if (searchingForDatasets.current === true && value === \"\") {\n        closeDatasetPopper()\n        searchingForDatasets.current = false\n      }\n\n      setPrompt(value)\n\n      // HACK to solve the issue https://ravenpack.atlassian.net/browse/RPX-4220\n      if (isSafari) {\n        inputRef?.current?.style.setProperty(\"padding-right\", \"1px\")\n        setTimeout(() => {\n          inputRef?.current?.style.setProperty(\"padding-right\", \"0px\")\n        })\n      }\n    }\n\n    const isSubmitDisabled = generating || !isValidPrompt || hidden\n\n    const controls: Array<React.ReactElement> = []\n\n    const showFilesButton =\n      !areDatasetsAdded && hasEntitlement(\"chat:file\") && !hideControls.includes(\"files\")\n    const showWatchlistButton =\n      hasEntitlement(\"chat:watchlist\") && !hideControls.includes(\"watchlist\")\n    const showSourceButton = !areFilesAdded && !hideControls.includes(\"source\")\n\n    const handleAddSourceClick = useSelectSourceAction({\n      defaultAction: isDatasetsOpen ? closeDatasetPopper : openDatasetPopper,\n      applyCallback: noop,\n    })\n\n    if (showSourceButton) {\n      controls.push(\n        <AddSourceButton\n          key=\"addSource\"\n          onClick={handleAddSourceClick}\n          active={isDatasetsOpen}\n          disabled={hidden}\n          tooltipDisabled={isDatasetsOpen}\n        />,\n      )\n    }\n\n    if (showWatchlistButton) {\n      controls.push(\n        <AddWatchlistButton\n          key=\"addWatchlist\"\n          onClick={handleOpenWatchlistModal}\n          disabled={hidden || isDatasetsOpen}\n          tooltipDisabled={isDatasetsOpen}\n        />,\n      )\n    }\n\n    if (showFilesButton) {\n      controls.push(\n        <AttachFileButton\n          key=\"attachFile\"\n          onClick={openFileModal}\n          disabled={hidden || isDatasetsOpen}\n          tooltipDisabled={isDatasetsOpen}\n        />,\n      )\n    }\n\n    return (\n      <Box\n        id={id}\n        className={CHAT_INPUT_WRAPPER_CLASS_NAME}\n        sx={{\n          zIndex: 20,\n          [`&:has(textarea:focus) .${SCOPE_DISPLAY_CLASS_NAME}`]: {\n            borderColor: \"rgba(255, 255, 255, 0.3)\",\n          },\n        }}\n      >\n        {!hidden && areActiveFilters ? (\n          <ChatInputFilters\n            scope={scope}\n            setScope={setScope}\n            className={SCOPE_DISPLAY_CLASS_NAME}\n            watchlistId={watchlistId}\n            setWatchlistId={setWatchlistId}\n            onFileClick={file => {\n              actions.view.onClick(file)\n            }}\n            removeFiles={removeFiles}\n            filesIds={filesIds}\n            openFilesModal={openFileModal}\n            openWatchlistModal={handleOpenWatchlistModal}\n            openScopeModal={openDatasetPopper}\n            onRemovePills={() => {\n              if (isDeviceKeyboardOpen) {\n                inputRef?.current?.focus()\n              }\n            }}\n            isHomePageChat={isHomePageChat}\n          />\n        ) : null}\n        <ChatInputContainer\n          ref={ref}\n          controls={controls}\n          isPopperOpen={isDatasetsOpen}\n          multiline={multiline || (isMobile && (inputHasFocus || prompt.length > 0))}\n          displayAttachFiles={!areDatasetsAdded}\n          hasAttachment={areActiveFilters}\n          className={CHAT_INPUT_CONTAINER_CLASS_NAME}\n          isHomePageChat={isHomePageChat}\n        >\n          <Box\n            className={CHAT_INPUT_CONTROLS_CLASS_NAME}\n            position=\"absolute\"\n            left={12}\n            bottom={isMobile ? 8 : 12}\n          >\n            {controls}\n          </Box>\n\n          <TextArea\n            placeholder={isDatasetsOpen ? \"Search for data sources\" : hiddenPlaceholder}\n            minRows={1}\n            maxRows={!prompt ? 1 : rows}\n            value={prompt}\n            onChange={hidden ? undefined : onChange}\n            onKeyDown={handleKeyDown}\n            autoComplete=\"off\"\n            maxLength={5000}\n            tabIndex={hidden ? -1 : undefined}\n            disabled={hidden}\n            ref={inputRef}\n            onFocus={() => {\n              setInputHasFocus(true)\n              onFocus?.()\n            }}\n            onBlur={() => setInputHasFocus(false)}\n          />\n\n          {generating && stopGenerating ? (\n            <GeneratingIcon onClick={stopGenerating} disabled={hidden} />\n          ) : (\n            <SubmitPromptButton\n              onClick={submitPrompt}\n              disabled={isSubmitDisabled}\n              variant={variant}\n            />\n          )}\n        </ChatInputContainer>\n      </Box>\n    )\n  },\n)\n\nexport {\n  ChatInput,\n  CHAT_INPUT_WRAPPER_CLASS_NAME,\n  CHAT_INPUT_CONTAINER_CLASS_NAME,\n  CHAT_INPUT_CONTROLS_CLASS_NAME,\n  SCOPE_DISPLAY_CLASS_NAME,\n}\n"],"names":["CHAT_INPUT_CONTAINER_CLASS_NAME","CHAT_INPUT_CONTROLS_CLASS_NAME","CHAT_INPUT_WRAPPER_CLASS_NAME","ChatInput","SCOPE_DISPLAY_CLASS_NAME","forwardRef","id","prompt","setPrompt","submitPrompt","variant","generating","stopGenerating","scope","setScope","isDatasetsOpen","openDatasetPopper","closeDatasetPopper","handleKeyDown","isValidPrompt","multiline","hidden","filesIds","setFilesIds","submitFileRef","inputRef","handleOpenWatchlistModal","watchlistId","setWatchlistId","isFreeTierEnabled","hideControls","placeholder","isHomePageChat","onFocus","ref","actions","useFileActions","searchingForDatasets","useRef","isMobile","isSafari","useDeviceInfo","isDeviceKeyboardOpen","useDeviceSize","hasEntitlement","useAccount","rows","hiddenPlaceholder","areFilesAdded","length","areWatchlistAdded","undefined","areDatasetsAdded","areActiveFilters","inputHasFocus","setInputHasFocus","useState","removeFiles","useCallback","ids","prev","filter","includes","selectFilesModal","useModal","openFileModal","handleOpen","selected","onUploadClick","current","Promise","resolve","open","onDeleteFile","fileId","onSuccess","onChange","event","value","target","style","setProperty","setTimeout","isSubmitDisabled","controls","showFilesButton","showWatchlistButton","showSourceButton","handleAddSourceClick","useSelectSourceAction","defaultAction","applyCallback","noop","push","AddSourceButton","onClick","active","disabled","tooltipDisabled","AddWatchlistButton","AttachFileButton","Box","className","sx","zIndex","borderColor","ChatInputFilters","onFileClick","file","view","openFilesModal","openWatchlistModal","openScopeModal","onRemovePills","focus","ChatInputContainer","isPopperOpen","displayAttachFiles","hasAttachment","position","left","bottom","TextArea","minRows","maxRows","onKeyDown","autoComplete","maxLength","tabIndex","onBlur","GeneratingIcon","SubmitPromptButton"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}